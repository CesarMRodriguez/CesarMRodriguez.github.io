<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">

  
  <script data-ad-client="ca-pub-9039902373505756" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z6J58MYYPV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-Z6J58MYYPV');
  </script>
  <title>Cesar Rodriguez | Personal blog</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="frida ctf challenge root detection">
  <meta name="author" content="Cesar Rodriguez">
  <meta name="generator" content="Hugo 0.101.0" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/venobox/venobox.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://cmrodriguez.me/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://cmrodriguez.me/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://cmrodriguez.me/images/favicon.png " type="image/x-icon">

</head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view" href="https://cmrodriguez.me"><img class="img-fluid" style="max-height: 5rem;"
          src="https://cmrodriguez.me/images/logo-hermosa2.png" alt="Cesar Rodriguez | Personal blog"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <div class="desktop-view">
          <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="https://twitter.com/warlockk87"><i class="ti-twitter-alt"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/CesarMRodriguez"><i class="ti-github"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.linkedin.com/in/cesar-mario-rodriguez/"><i class="ti-linkedin"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.instagram.com/cesarm_rodriguez/"><i class="ti-instagram"></i></a>
            </li>
            
          </ul>
        </div>

        <a class="navbar-brand mx-auto desktop-view" href="https://cmrodriguez.me"><img class="img-fluid" style="max-height: 5rem;"
            src="https://cmrodriguez.me/images/logo-hermosa2.png" alt="Cesar Rodriguez | Personal blog"></a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://cmrodriguez.me/about">About</a>
          </li>
          
          
          
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              Trainings
            </a>
            <div class="dropdown-menu">
              
              <a class="dropdown-item" href="https://cmrodriguez.me/blog/advanced-android-exploitation-es">Advanced Android Exploitation (ES)</a>
              
            </div>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://cmrodriguez.me/blog">Post</a>
          </li>
          
          
          
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              Guides
            </a>
            <div class="dropdown-menu">
              
              <a class="dropdown-item" href="https://cmrodriguez.me/blog/frida-scripting-guide">Frida Scripting Guide</a>
              
              <a class="dropdown-item" href="https://cmrodriguez.me/blog/hpandro">Solving hpAndro</a>
              
            </div>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://cmrodriguez.me/contact">Contact</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://cmrodriguez.me/search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/categories/frida"
          class="text-primary">Frida</a>
        
        <a href="/categories/android"
          class="text-primary">Android</a>
        
        <a href="/categories/ctf"
          class="text-primary">Ctf</a>
        
        <a href="/categories/challenge"
          class="text-primary">Challenge</a>
        
        <a href="/categories/root-detection"
          class="text-primary">Root detection</a>
        
        <h2>Solving CTF with Frida - Part 5</h2>
        <div class="mb-3 post-meta">
          <span>By Cesar Rodriguez</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>09 August 2021</span>
          
        </div>
        
        <img src="https://cmrodriguez.me/images/featured-post/ctf-challenge.png" class="img-fluid w-100 mb-4" alt="Solving CTF with Frida - Part 5">
        
        <div class="content mb-5">
          <p>In this series of posts I&rsquo;ll be solving some persistence challenges from <a href="http://ctf.hpandro.raviramesh.info/">hpandro ctf challenges</a>. hpAndro created an Android application with multiple vulnerabilities, following the <a href="https://github.com/OWASP/owasp-mstg">MSTG</a>.</p>
<p>We have eleven different challenges related to root detection mechanisms. Most of the root detection validations work in the same way, so I&rsquo;ll do a generic analysis of how it works and then I&rsquo;ll give details on how each validation works. List of validations:</p>
<ul>
<li>Availability of BusyBox.</li>
<li>Dangerous Properties.</li>
<li>Potentially Dangerous applications.</li>
<li>RootCloak available.</li>
<li>RootManagement apps availables.</li>
<li>RW System state.</li>
<li>SafetyNet validation.</li>
<li>StatSystemCall.</li>
<li>Su Binaries available.</li>
<li>Su exists.</li>
<li>Test Keys availables.</li>
</ul>
<p>In order to execute a validation the application does the following:</p>
<p>a) Validate the state of the cellphone at start in order to check if the control have to be bypassed to get the flag. As an example in the RootManagement apps exercise the application validates if there is any RootManagement app in the cellphone. If there is none, the exercise would not have any sense because the flag would be retrieved without doing anything. So the application checks this, and if the control is not bypasseable, the application will launch an error whenever the user wants to execute the exercise (we&rsquo;ll check this later on)</p>
<p>b) Whenever the Task is executed, and a button of ROOT CHECK is pressed, the application execues the validation and if the service returns true, the flag is retrieved from the service.</p>
<h3 id="step-a">Step a</h3>
<p>Whenever the application starts up, the com.hpandro.androidsecurity.ui.activity.SplashActivity is called. The method onCreate has the following code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span> 
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">bundle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">bundle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_splash</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rootDetection</span><span class="o">();</span>
</span></span></code></pre></div><p>If we check what the rootDetection method does, we&rsquo;ll see that it executes the same control that is then executed on each exercise and calls <em>checkRootFlag</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">rootDetection</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BaseActivity</span> <span class="n">baseActivity</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkRootFlag</span><span class="o">(</span><span class="n">SharedPrefsConst</span><span class="o">.</span><span class="na">PREF_RootManagementApps</span><span class="o">,</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagRootManagementApps</span><span class="o">(</span><span class="n">baseActivity</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkRootFlag</span><span class="o">(</span><span class="n">SharedPrefsConst</span><span class="o">.</span><span class="na">PREF_PotentiallyDangerousApps</span><span class="o">,</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagPotentialDangerousApps</span><span class="o">(</span><span class="n">baseActivity</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkRootFlag</span><span class="o">(</span><span class="n">SharedPrefsConst</span><span class="o">.</span><span class="na">PREF_TestKeys</span><span class="o">,</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagTestKeys</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkRootFlag</span><span class="o">(</span><span class="n">SharedPrefsConst</span><span class="o">.</span><span class="na">PREF_DangerousProps</span><span class="o">,</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagDangerousProps</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkRootFlag</span><span class="o">(</span><span class="n">SharedPrefsConst</span><span class="o">.</span><span class="na">PREF_BusyBoxBinary</span><span class="o">,</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagBusyBoxBinaries</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkRootFlag</span><span class="o">(</span><span class="n">SharedPrefsConst</span><span class="o">.</span><span class="na">PREF_SuBinary</span><span class="o">,</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagSUBinaries</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkRootFlag</span><span class="o">(</span><span class="n">SharedPrefsConst</span><span class="o">.</span><span class="na">PREF_SuExists</span><span class="o">,</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagSUExists</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkRootFlag</span><span class="o">(</span><span class="n">SharedPrefsConst</span><span class="o">.</span><span class="na">PREF_RootCloakingApps</span><span class="o">,</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagRootClockingApps</span><span class="o">(</span><span class="n">baseActivity</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkRootFlag</span><span class="o">(</span><span class="n">SharedPrefsConst</span><span class="o">.</span><span class="na">PREF_RWSystem</span><span class="o">,</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagRWSystems</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkRootFlag</span><span class="o">(</span><span class="n">SharedPrefsConst</span><span class="o">.</span><span class="na">PREF_StatSystemcall</span><span class="o">,</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkRunningProcesses</span><span class="o">(</span><span class="n">baseActivity</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">SharedPreferences</span> <span class="n">sharedPreferences2</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">sharedPreferences</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">sharedPreferences2</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Intrinsics</span><span class="o">.</span><span class="na">throwUninitializedPropertyAccessException</span><span class="o">(</span><span class="s">&#34;sharedPreferences&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>The <em>checkRootFlag</em> stores a value in a shared preference folder, which adds an F whether the validation returns &ldquo;true&rdquo; or 0 in the other case:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">checkRootFlag</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">z</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">str2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SharedPreferences</span> <span class="n">sharedPrefRootDetection</span> <span class="o">=</span> <span class="n">MainApp</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getSharedPrefRootDetection</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">string</span> <span class="o">=</span> <span class="n">sharedPrefRootDetection</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">AppConstant</span><span class="o">.</span><span class="na">pref</span><span class="o">,</span> <span class="s">&#34;00&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">z</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">str2</span> <span class="o">=</span> <span class="n">Intrinsics</span><span class="o">.</span><span class="na">stringPlus</span><span class="o">(</span><span class="n">string</span><span class="o">,</span> <span class="s">&#34;F&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">str2</span> <span class="o">=</span> <span class="n">Intrinsics</span><span class="o">.</span><span class="na">stringPlus</span><span class="o">(</span><span class="n">string</span><span class="o">,</span> <span class="s">&#34;0&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">MainApp</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getSharedPrefRootDetection</span><span class="o">().</span><span class="na">edit</span><span class="o">().</span><span class="na">putBoolean</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">z</span><span class="o">).</span><span class="na">apply</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SharedPreferences</span><span class="o">.</span><span class="na">Editor</span> <span class="n">edit</span> <span class="o">=</span> <span class="n">MainApp</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getSharedPrefRootDetection</span><span class="o">().</span><span class="na">edit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">AppConstant</span><span class="o">.</span><span class="na">pref</span><span class="o">,</span> <span class="n">str2</span><span class="o">).</span><span class="na">apply</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>If we check the shared preferences folder we see the following files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vbox86p:/data/data/com.hpandro.androidsecurity/shared_prefs <span class="c1"># ls -al                                                                                                        </span>
</span></span><span class="line"><span class="cl">total <span class="m">104</span>
</span></span><span class="line"><span class="cl">drwxrwx--x  <span class="m">2</span> u0_a101 u0_a101 <span class="m">4096</span> 2021-07-25 12:30 .
</span></span><span class="line"><span class="cl">drwx------ <span class="m">10</span> u0_a101 u0_a101 <span class="m">4096</span> 2021-07-25 12:29 ..
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101  <span class="m">277</span> 2021-07-24 20:09 AndroidSecurity.xml
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101  <span class="m">949</span> 2021-07-24 20:09 EmulatorDetection.xml
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101  <span class="m">188</span> 2021-07-24 20:09 FirebaseAppHeartBeat.xml
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101   <span class="m">65</span> 2021-07-25 12:30 GTPlayerPurchases.xml
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101   <span class="m">65</span> 2021-07-25 12:30 OneSignal.xml
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101   <span class="m">65</span> 2021-07-25 12:30 OneSignalTriggers.xml
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101 <span class="m">1066</span> 2021-07-24 20:09 RootDetection.xml
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101  <span class="m">127</span> 2021-07-24 20:09 WebViewChromiumPrefs.xml
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101  <span class="m">486</span> 2021-07-24 20:09 admob.xml
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101  <span class="m">270</span> 2021-07-24 20:09 admob_user_agent.xml
</span></span><span class="line"><span class="cl">-rw-rw----  <span class="m">1</span> u0_a101 u0_a101 <span class="m">1067</span> 2021-07-25 12:29 com.google.android.gms.measurement.prefs.xml
</span></span></code></pre></div><p>The file being updated is <em>RootDetection.xml</em>. The content has the following format:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39; standalone=&#39;yes&#39; ?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;map&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boolean</span> <span class="na">name=</span><span class="s">&#34;PotentiallyDangerousApps&#34;</span> <span class="na">value=</span><span class="s">&#34;false&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boolean</span> <span class="na">name=</span><span class="s">&#34;StatSystemcall&#34;</span> <span class="na">value=</span><span class="s">&#34;false&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&#34;RootManagementAppsStr&#34;</span><span class="nt">&gt;</span>00F<span class="nt">&lt;/string&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&#34;SuBinaryStr&#34;</span><span class="nt">&gt;</span>00F<span class="nt">&lt;/string&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&#34;StatSystemcallStr&#34;</span><span class="nt">&gt;</span>000<span class="nt">&lt;/string&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&#34;RWSystemStr&#34;</span><span class="nt">&gt;</span>000<span class="nt">&lt;/string&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boolean</span> <span class="na">name=</span><span class="s">&#34;RootManagementApps&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&#34;SuExistsStr&#34;</span><span class="nt">&gt;</span>00F<span class="nt">&lt;/string&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boolean</span> <span class="na">name=</span><span class="s">&#34;BusyBoxBinary&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boolean</span> <span class="na">name=</span><span class="s">&#34;RWSystem&#34;</span> <span class="na">value=</span><span class="s">&#34;false&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&#34;PotentiallyDangerousAppsStr&#34;</span><span class="nt">&gt;</span>000<span class="nt">&lt;/string&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&#34;DangerousPropsStr&#34;</span><span class="nt">&gt;</span>00F<span class="nt">&lt;/string&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boolean</span> <span class="na">name=</span><span class="s">&#34;DangerousProps&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boolean</span> <span class="na">name=</span><span class="s">&#34;SuBinary&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boolean</span> <span class="na">name=</span><span class="s">&#34;RootCloakingApps&#34;</span> <span class="na">value=</span><span class="s">&#34;false&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&#34;RootCloakingAppsStr&#34;</span><span class="nt">&gt;</span>000<span class="nt">&lt;/string&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&#34;BusyBoxBinaryStr&#34;</span><span class="nt">&gt;</span>00F<span class="nt">&lt;/string&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boolean</span> <span class="na">name=</span><span class="s">&#34;SuExists&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boolean</span> <span class="na">name=</span><span class="s">&#34;TestKeys&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">&#34;TestKeysStr&#34;</span><span class="nt">&gt;</span>00F<span class="nt">&lt;/string&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/map&gt;</span>
</span></span></code></pre></div><h3 id="step-b">Step b</h3>
<p>Each control has an Activity that launches the validation which retrieves the flag in case the root detection returns false. The activity has button that generates the control:</p>
<p><img src="/images/featured-post/hpandro-root-exercise.png" alt="hpAndro Root with button"></p>
<p>If the control is passed, the flag is returned:</p>
<p><img src="/images/featured-post/hpandro-root-success.png" alt="hpAndro Root success"></p>
<p>and in case the control is not passed, nothing happens.</p>
<p>The activity calls an <em>init</em> method that sets the <em>onCliCkListener</em> of the button which will launch the validation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">bundle</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">bundle</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_X_task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">init</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Toolbar</span> <span class="n">toolbar</span> <span class="o">=</span> <span class="o">(</span><span class="n">Toolbar</span><span class="o">)</span> <span class="n">_$_findCachedViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">toolbarTask</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">toolbar</span><span class="o">,</span> <span class="s">&#34;toolbarTask&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">toolbar</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">X</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; Task&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">((</span><span class="n">Toolbar</span><span class="o">)</span> <span class="n">_$_findCachedViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">toolbarTask</span><span class="o">)).</span><span class="na">setNavigationOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">BusyBoxBinaryTaskActivity$init$1</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">((</span><span class="n">Button</span><span class="o">)</span> <span class="n">_$_findCachedViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btnCheRoot</span><span class="o">)).</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">XTaskActivity$init$2</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>The button creates an instance of a Listener called like the activity, but adding an $init$2 to the end. As an example the Listener that solves the control on <em>BusyBoxBinaryTaskActivity</em> is called <em>BusyBoxBinaryTaskActivity$init$2</em>. The validation is executed in the onClick method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">string</span> <span class="o">=</span> <span class="n">MainApp</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getSharedPrefRootDetection</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;XStr&#34;</span><span class="o">,</span> <span class="s">&#34;00&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//validatin of the root control
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="n">checkFlagBusyBoxBinaries</span> <span class="o">=</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagBusyBoxBinaries</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">string</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="s">&#34;F&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="n">checkFlagBusyBoxBinaries</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//generate error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">textView2</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">busybox_binaries</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; detected on this location\n\n&#34;</span> <span class="o">+</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getX</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">XTaskActivity</span><span class="o">.</span><span class="na">access$getPresenter$p</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">getRootDetectFlag</span><span class="o">(</span><span class="s">&#34;bbb&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>As it can be seen two different controls are validated. The first one is related to the value on the SharedPreference set on the step 1, and the second one is related to the specific control executed on the application. We have two different scenarios to face:</p>
<ol>
<li>The Android OS has the condition of rooted analyzed in the Task, so the sharedPreference value will have an F, and then the RootDetectionUtils will return true in the evaluation.</li>
</ol>
<p>In this case the function to overwrite should be the one that returns the boolean checking the status. As an example the following script was created to solve the BusyBox challenge:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">RootDetectionUtils</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;com.hpandro.androidsecurity.utils.rootDetection.RootDetectionUtils$Companion&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">RootDetectionUtils</span><span class="p">.</span><span class="nx">checkFlagBusyBoxBinaries</span><span class="p">.</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><ol start="2">
<li>The Android OS does not have the condition of rooted analyzed, so the sharedPreference will not have an F and the RootDetectionUtils will return false. In the second case, the application shows an error message:</li>
</ol>
<p><img src="/images/featured-post/hpandro-root-error.png" alt="hpAndro Root error"></p>
<p>In this case there are two basic alternatives. The first one is changing the environment, so the first validation sets the sharedPreference value with &ldquo;F&rdquo;, or changing the validation that checks if the condition is met to execute the root detection method.</p>
<p>As the first condition requires chaging and installing multiple applications, I decided to patch the app to bypass the validation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">StringKt</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;kotlin.text.StringsKt__StringsKt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">StringKt</span><span class="p">.</span><span class="nx">contains$default</span><span class="p">.</span><span class="nx">overload</span><span class="p">(</span><span class="s1">&#39;java.lang.CharSequence&#39;</span><span class="p">,</span> <span class="s1">&#39;java.lang.CharSequence&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;java.lang.Object&#39;</span><span class="p">).</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">charSeq</span><span class="p">,</span> <span class="nx">charSeq2</span><span class="p">,</span><span class="nx">boolZ</span><span class="p">,</span> <span class="nx">intI</span><span class="p">,</span> <span class="nx">objO</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">charSeq2</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;F&#34;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;entra&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">contains$default</span><span class="p">(</span><span class="nx">charSeq</span><span class="p">,</span> <span class="nx">charSeq2</span><span class="p">,</span><span class="nx">boolZ</span><span class="p">,</span> <span class="nx">intI</span><span class="p">,</span> <span class="nx">objO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>In this script I patched the <em>StringsKt.contains$default</em> method found in the XTaskActivity$init$2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(!</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">string</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="s">&#34;F&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="n">detectPotentiallyDangerousApps</span><span class="o">)</span> <span class="o">{</span>
</span></span></code></pre></div><p>The following validation was added:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">charSeq2</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;F&#34;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;entra&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>because this method is used in multiple places in the application, so if it is changed to return always true, it will generate errors in the app. So in order to detect if the validation is the one used in the conditional for the rootCheck, I analyzed the second parameter from the function and if it has an &ldquo;F&rdquo;, I return always true.      <br>
Let&rsquo;s check now how the validations are done in order to understand what the applications do to detect Root mechanisms. All the controls can be found in the <em>com.hpandro.androidsecurity.utils.rootDetection.RootDetectionUtils</em> class:</p>
<h3 id="availability-of-busybox">Availability of BusyBox.</h3>
<p>BusyBox is a software suite that provides several Unix utilities in a single executable file. It runs in a variety of POSIX environments such as Linux, Android, and FreeBSD, although many of the tools it provides are designed to work with interfaces provided by the Linux kernel. It was specifically created for embedded operating systems with very limited resources. By default busybox is not installed in default Android firmwares. So it is a reasonable to assume that if busybox is in the system, it is because someone installed it (which would require root permissions). In this case a person could bypass this control by changing the binary name from <em>busybox</em> to another one. The method that validates it is <em>checkFlagBusyBoxBinaries</em>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkFlagBusyBoxBinaries</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">checkForBinary</span><span class="o">(</span><span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">BINARY_BUSYBOX</span><span class="o">);</span> <span class="c1">//&#34;busybox&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><p>It calls the checkForBunary, which validates if the binary (busybox) can be found on some paths (<em>getPath</em>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkForBinary</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullParameter</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="s">&#34;filename&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span><span class="o">[]</span> <span class="n">paths</span> <span class="o">=</span> <span class="n">getPaths</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">z</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str2</span> <span class="o">:</span> <span class="n">paths</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">str3</span> <span class="o">=</span> <span class="n">str2</span> <span class="o">+</span> <span class="n">str</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">str2</span><span class="o">,</span> <span class="n">str</span><span class="o">).</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">Object</span><span class="o">)</span> <span class="o">(</span><span class="s">&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; &#34;</span> <span class="o">+</span> <span class="n">str3</span> <span class="o">+</span> <span class="s">&#34; binary detected!&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">z</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">z</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>In this case getPath generates a String Array containing some hardcoded paths (<em>RootDetectionUtils.suPaths</em>) and the paths from the <em>PATH</em> environment variable:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">getPaths</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span><span class="o">[]</span> <span class="n">strArr</span> <span class="o">=</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">suPaths</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ArrayList</span> <span class="n">arrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">(</span><span class="n">CollectionsKt</span><span class="o">.</span><span class="na">listOf</span><span class="o">((</span><span class="n">Object</span><span class="o">[])</span> <span class="o">((</span><span class="n">String</span><span class="o">[])</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">strArr</span><span class="o">,</span> <span class="n">strArr</span><span class="o">.</span><span class="na">length</span><span class="o">))));</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">&#34;PATH&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span><span class="o">[]</span> <span class="n">array2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Regex</span><span class="o">(</span><span class="s">&#34;:&#34;</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">0</span><span class="o">).</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">array2</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span><span class="o">[]</span> <span class="n">strArr2</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">[])</span> <span class="n">array2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str2</span> <span class="o">:</span> <span class="n">strArr2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">str3</span> <span class="o">=</span> <span class="o">!</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">endsWith$default</span><span class="o">(</span><span class="n">str2</span><span class="o">,</span> <span class="s">&#34;/&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">str2</span> <span class="o">+</span> <span class="sc">&#39;/&#39;</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">arrayList</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">str3</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">arrayList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">str3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">array3</span> <span class="o">=</span> <span class="n">arrayList</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">array3</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">[])</span> <span class="n">array3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="dangerous-properties">Dangerous Properties.</h3>
<p>The application validates some properties set on <em>/system/default.prop</em>. This properties enable some features on the OS that could be dangerous. In this case the following two values are validated:</p>
<ul>
<li>ro.debuggable = 1 (DiskLruCache.VERSION_1) makes any application debuggable despite the value it has on the AndroidManifest.</li>
<li>ro.secure = 0, allows adb to be connected with a high privilege user (like root).</li>
</ul>
<p>These paremeters are considered dangerous, so the default Android firmwares do not set them on those values. In this case it is not easy to modify that file, because it is being recovered each time the Android firmware is restarted. Also it would disable some functionalities desired on rooted devices. The method that does this is the following one:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkFlagDangerousProps</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HashMap</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;ro.debuggable&#34;</span><span class="o">,</span> <span class="n">DiskLruCache</span><span class="o">.</span><span class="na">VERSION_1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;ro.secure&#34;</span><span class="o">,</span> <span class="s">&#34;0&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span><span class="o">[]</span> <span class="n">propsReader</span> <span class="o">=</span> <span class="n">propsReader</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">propsReader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">z</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str</span> <span class="o">:</span> <span class="n">propsReader</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str2</span> <span class="o">:</span> <span class="n">hashMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">str3</span> <span class="o">=</span> <span class="n">str</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str3</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str2</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">str4</span> <span class="o">=</span> <span class="sc">&#39;[&#39;</span> <span class="o">+</span> <span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">hashMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">str2</span><span class="o">))</span> <span class="o">+</span> <span class="sc">&#39;]&#39;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str3</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str4</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">Object</span><span class="o">)</span> <span class="o">(</span><span class="s">&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; &#34;</span> <span class="o">+</span> <span class="n">str2</span> <span class="o">+</span> <span class="s">&#34; = &#34;</span> <span class="o">+</span> <span class="n">str4</span> <span class="o">+</span> <span class="s">&#34; detected!&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">z</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">z</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>  
</span></span></code></pre></div><h3 id="potentially-dangerous-applications">Potentially Dangerous applications.</h3>
<p>In this case the application validates if some applications that are known to be malicious are installed in the phone. In this case the way to validate it is using the following method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">detectPotentiallyDangerousApps</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">strArr</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullParameter</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="s">&#34;mContext&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullParameter</span><span class="o">(</span><span class="n">strArr</span><span class="o">,</span> <span class="s">&#34;additionalDangerousApps&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ArrayList</span> <span class="n">arrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Companion</span> <span class="n">companion</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span><span class="o">[]</span> <span class="n">knownDangerousAppsPackages</span> <span class="o">=</span> <span class="n">companion</span><span class="o">.</span><span class="na">getKnownDangerousAppsPackages</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">arrayList</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">((</span><span class="n">String</span><span class="o">[])</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">knownDangerousAppsPackages</span><span class="o">,</span> <span class="n">knownDangerousAppsPackages</span><span class="o">.</span><span class="na">length</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!(</span><span class="n">strArr</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">arrayList</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">((</span><span class="n">String</span><span class="o">[])</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">strArr</span><span class="o">,</span> <span class="n">strArr</span><span class="o">.</span><span class="na">length</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">companion</span><span class="o">.</span><span class="na">isAnyPackageFromListInstalled</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">arrayList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>The application then calls the <em>isAnyPackageFromListInstalled</em> which checks if any package is in the cellphone by consuming the <em>PackageManager</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isAnyPackageFromListInstalled</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">PackageManager</span> <span class="n">packageManager</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">packageManager</span><span class="o">,</span> <span class="s">&#34;mContext!!.packageManager&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">z</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">packageManager</span><span class="o">.</span><span class="na">getPackageInfo</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">Object</span><span class="o">)</span> <span class="o">(</span><span class="s">&#34;&gt;&gt;&gt;&gt;&gt;&gt; &#34;</span> <span class="o">+</span> <span class="n">str</span> <span class="o">+</span> <span class="s">&#34; ROOT management app detected!&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">z</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PackageManager</span><span class="o">.</span><span class="na">NameNotFoundException</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">z</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="rootcloak-available">RootCloak available.</h3>
<p>RootCloak applications are apps used to hide the fact that the phone is rooted. This is done by hooking many functionalities used in order to validate if the application is rooted, like the ones seen in this post, and changing them to avoid the validation. This can be done only if the rootcloak application has root permissions (to be able to reach all the applications).</p>
<p>So if the application detects any of these applications, it infers that the cellphone is rooted. This is done in a similar way as in the case of the dangerous applications, but in this case the applications being validated are related to known RootCloak applications.</p>
<h3 id="rootmanagement-apps-availables">RootManagement apps availables.</h3>
<p>RootManagement apps are used for managing the permissions each application whenever it is opened. If the user wants the application to run as root, they have to select it on this app and then whenever the app is opened, it will run with high privileges.</p>
<p>As it happens with RootCloak applications, these must be run as a root user. So if hpAndro finds any of these apps in the cellphone installed, it will infer that the phone is rooted.</p>
<h3 id="rw-system-state">RW System state.</h3>
<p>This validation checks the state of the mounted partitions. This is done by executing the <em>mount</em> command which returns something like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">tmpfs on /dev <span class="nb">type</span> tmpfs <span class="o">(</span>rw,seclabel,nosuid,relatime,mode<span class="o">=</span>755<span class="o">)</span>
</span></span><span class="line"><span class="cl">devpts on /dev/pts <span class="nb">type</span> devpts <span class="o">(</span>rw,seclabel,relatime,mode<span class="o">=</span>600<span class="o">)</span>
</span></span><span class="line"><span class="cl">proc on /proc <span class="nb">type</span> proc <span class="o">(</span>rw,relatime,gid<span class="o">=</span>3009,hidepid<span class="o">=</span>2<span class="o">)</span>
</span></span><span class="line"><span class="cl">sysfs on /sys <span class="nb">type</span> sysfs <span class="o">(</span>rw,seclabel,relatime<span class="o">)</span>
</span></span><span class="line"><span class="cl">selinuxfs on /sys/fs/selinux <span class="nb">type</span> selinuxfs <span class="o">(</span>rw,relatime<span class="o">)</span>
</span></span><span class="line"><span class="cl">tmpfs on /mnt <span class="nb">type</span> tmpfs <span class="o">(</span>rw,seclabel,nosuid,nodev,noexec,relatime,mode<span class="o">=</span>755,gid<span class="o">=</span>1000<span class="o">)</span>
</span></span><span class="line"><span class="cl">tmpfs on /apex <span class="nb">type</span> tmpfs <span class="o">(</span>rw,seclabel,nosuid,nodev,noexec,relatime,mode<span class="o">=</span>755<span class="o">)</span>
</span></span><span class="line"><span class="cl">/dev/block/sda4 on / <span class="nb">type</span> ext4 <span class="o">(</span>ro,seclabel,nodev,noatime,block_validity,delalloc,barrier,user_xattr<span class="o">)</span>
</span></span><span class="line"><span class="cl">none on /dev/blkio <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,blkio<span class="o">)</span>
</span></span><span class="line"><span class="cl">none on /dev/cpuctl <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,cpu<span class="o">)</span>
</span></span><span class="line"><span class="cl">none on /acct <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,cpuacct<span class="o">)</span>
</span></span><span class="line"><span class="cl">none on /dev/cpuset <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,cpuset,noprefix,release_agent<span class="o">=</span>/sbin/cpuset_release_agent<span class="o">)</span>
</span></span><span class="line"><span class="cl">none on /dev/memcg <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,memory<span class="o">)</span>
</span></span><span class="line"><span class="cl">none on /dev/stune <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,schedtune<span class="o">)</span>
</span></span></code></pre></div><p>The application parses the output of that command, and checks if any of the common partitions android has has a rw status. That could mean that the OS was modified in order to change the default status from the partitions, and this can be done only if the owner of the phone or emulator has a root user to remount the default partitions.</p>
<p>This is done with the following code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkFlagRWSystems</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span><span class="o">[]</span> <span class="n">mountReader</span> <span class="o">=</span> <span class="n">companion2</span><span class="o">.</span><span class="na">mountReader</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">mountReader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i3</span> <span class="o">=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">mountReader</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i4</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">z</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(</span><span class="n">i4</span> <span class="o">&lt;</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">str3</span> <span class="o">=</span> <span class="n">mountReader</span><span class="o">[</span><span class="n">i4</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span><span class="o">[]</span> <span class="n">array</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Regex</span><span class="o">(</span><span class="s">&#34; &#34;</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="n">str3</span><span class="o">,</span> <span class="n">i2</span><span class="o">).</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">i2</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">array</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span><span class="o">[]</span> <span class="n">pathsThatShouldNotBeWritable</span> <span class="o">=</span> <span class="n">companion2</span><span class="o">.</span><span class="na">getPathsThatShouldNotBeWritable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">length2</span> <span class="o">=</span> <span class="n">pathsThatShouldNotBeWritable</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">str4</span> <span class="o">=</span> <span class="n">str2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">i6</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="o">(</span><span class="n">i6</span> <span class="o">&lt;</span> <span class="n">length2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">String</span> <span class="n">str5</span> <span class="o">=</span> <span class="n">pathsThatShouldNotBeWritable</span><span class="o">[</span><span class="n">i6</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                    <span class="o">...</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">strArr3</span><span class="o">[</span><span class="n">i7</span><span class="o">],</span> <span class="s">&#34;rw&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">Object</span><span class="o">)</span> <span class="o">(</span><span class="n">str5</span> <span class="o">+</span> <span class="s">&#34; path is mounted with rw permissions! &#34;</span> <span class="o">+</span> <span class="n">str3</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                            <span class="n">z</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                        <span class="n">i7</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">mountReader</span> <span class="o">=</span> <span class="n">strArr</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">strArr3</span> <span class="o">=</span> <span class="n">strArr3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">i3</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">...</span>
</span></span></code></pre></div><h3 id="safetynet-validation">SafetyNet validation.</h3>
<p>SafetyNet from Google offers a complete suite of features to keep the Android ecosystem in check. The set of services and APIs from SafetyNet are focused on safety which when tied with an application opens up a new realm to safeguard the app against security threats. SafetyNet Attestation API – Checks whether the gadget the application is attempting to run on is tampered or potentially compromised. It compares the device’s profile with that of Google certified devices and verifies if the device or the software running on it is Android compatible.</p>
<p>The API verifies the following:</p>
<ul>
<li>Whether the device is rooted or not.</li>
<li>Whether the device is monitored.</li>
<li>Whether the bootloader has been unlocked.</li>
<li>Whether the device has recognized hardware parameters.</li>
<li>Whether the software is Android compatible.</li>
<li>Whether the device is free form malicious apps.</li>
</ul>
<p>In order to execute the call to the SafetyNet servers, hpAndro executes the following code in the <em>com.hpandro.androidsecurity.ui.activity.task.rootDetection.SafetyNetTaskActivity</em> class:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">sendSafetyNetRequest</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">byte</span><span class="o">[]</span> <span class="n">requestNonce</span> <span class="o">=</span> <span class="n">getRequestNonce</span><span class="o">(</span><span class="s">&#34;Safety Net Sample: &#34;</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">requestNonce</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">SafetyNetTaskActivity</span> <span class="n">safetyNetTaskActivity</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SafetyNetClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">SafetyNet</span><span class="o">.</span><span class="na">getClient</span><span class="o">((</span><span class="n">Activity</span><span class="o">)</span> <span class="n">safetyNetTaskActivity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="s">&#34;SafetyNet.getClient(this@SafetyNetTaskActivity)&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Task</span><span class="o">&lt;</span><span class="n">SafetyNetApi</span><span class="o">.</span><span class="na">AttestationResponse</span><span class="o">&gt;</span> <span class="n">attest</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">attest</span><span class="o">(</span><span class="n">requestNonce</span><span class="o">,</span> <span class="s">&#34;AIzaSyAampEGuuEzC5zW0Wvd3cjx8uWkVfd8O4Y&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">attest</span><span class="o">,</span> <span class="s">&#34;client.attest(nonce, \&#34;AI…C5zW0Wvd3cjx8uWkVfd8O4Y\&#34;)&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">attest</span><span class="o">.</span><span class="na">addOnSuccessListener</span><span class="o">(</span><span class="n">safetyNetTaskActivity</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">mSuccessListener</span><span class="o">).</span><span class="na">addOnFailureListener</span><span class="o">(</span><span class="n">safetyNetTaskActivity</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">mFailureListener</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="statsystemcall">StatSystemCall.</h3>
<p>In this case the validation used is identical to the one related to the RWSystem validation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">string</span> <span class="o">=</span> <span class="n">MainApp</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getSharedPrefRootDetection</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;StatSystemcallStr&#34;</span><span class="o">,</span> <span class="s">&#34;00&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">checkFlagRWSystems</span> <span class="o">=</span> <span class="n">RootDetectionUtils</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">checkFlagRWSystems</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">string</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="s">&#34;F&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="n">checkFlagRWSystems</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">StatSystemCallTaskActivity</span> <span class="n">statSystemCallTaskActivity</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">StatSystemCallTaskActivity</span><span class="o">.</span><span class="na">access$getPresenter$p</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">getRootDetectFlag</span><span class="o">(</span><span class="s">&#34;rpro&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="su-binaries-available">Su Binaries available.</h3>
<p>The control in this section is like the one of Dangerous Applications, but in this case what is being validated is the existence of the <em>su</em> binary.</p>
<h3 id="su-exists">Su exists.</h3>
<p>This control also validates the existence of su. But instead of searching in the path for the binary, it executes the which command in order to see whether the os returns any location where the su is found:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkFlagSUExists</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Process</span> <span class="n">process</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">z</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">process</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">&#34;/system/xbin/which&#34;</span><span class="o">,</span> <span class="s">&#34;su&#34;</span><span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">process</span><span class="o">,</span> <span class="s">&#34;process&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">process</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">())).</span><span class="na">readLine</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">z</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">process</span><span class="o">.</span><span class="na">destroy</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">z</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="test-keys-availables">Test Keys availables.</h3>
<p>Verifies if the Build.TAGS variable has the following value: &ldquo;test-keys&rdquo;.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkFlagTestKeys</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">Build</span><span class="o">.</span><span class="na">TAGS</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">str</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="s">&#34;test-keys&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>This property is generated when the OS is built. The keys are used to sign all the system applications whenever the firmware is packed. These applications are being included in the /system/app folder generally and runs with the &ldquo;system&rdquo; user. Whenever the Android image is built, if any of the keys found in &ldquo;build/target/product/security&rdquo; is used, the system sets the Build.TAGS variable with <em>test-keys</em>.</p>
<p>As these kets are public, it is not recommended to use it to sign any application, as an attacker could generate an &ldquo;updated&rdquo; application (it would be valid because of the use of the system keys) with a malicious payload, which in case it were installed would run as a priviledged user.</p>
<p>If the key used is valid but not the ones publicly available, whenever the app signing step is executed, the Build.TAGS parameter will have the value &ldquo;release-keys&rdquo;.</p>
<h3 id="conclusion">Conclusion</h3>
<p>The controls shown in this application are commonly seen in production applications. As pentesters, it is important to understand them in order to find patterns in the applications we are analyzing to try to detect these controls and patch them in order to continue with the security analysis of the target. As a developer it is good to know how the controls work and how an attacker could try to bypass them.</p>

        </div>

        
        
      </div>
    </div>
  </div>
</section>



<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><i
                class="ti-twitter mr-3 text-primary"></i>@warlockk87</li>
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>Buenos Aires, Argentina</li>
          <li class="mb-3"><a class="text-dark" href="mailto:cmrodriguez.mobile@gmail.com"><i
                class="ti-email mr-3 text-primary"></i>cmrodriguez.mobile@gmail.com</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://twitter.com/warlockk87">twitter</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://github.com/CesarMRodriguez">github</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.linkedin.com/in/cesar-mario-rodriguez/">linkedin</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.instagram.com/cesarm_rodriguez/">instagram</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/categories/android">Android</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/automation">Automation</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/bug">Bug</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/challenge">Challenge</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ctf">Ctf</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/emulation-detection">Emulation detection</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/frida">Frida</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/http">HTTP</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/https">HTTPS</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/misc">Misc</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/pixeldungeon">Pixeldungeon</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/root-detection">Root detection</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/sqlite">Sqlite</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/tcp">Tcp</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/trainings">Trainings</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/udp">UDP</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/websocket">Websocket</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/about">About</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/blog">Post</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/contact">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | copyright © 2020 <a href="https://cmrodriguez.me">Cesar Rodriguez</a> All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://cmrodriguez.me/index.json"
</script>

<!-- JS Plugins -->

<script src="https://cmrodriguez.me/plugins/jQuery/jquery.min.js"></script>

<script src="https://cmrodriguez.me/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://cmrodriguez.me/plugins/slick/slick.min.js"></script>

<script src="https://cmrodriguez.me/plugins/venobox/venobox.min.js"></script>

<script src="https://cmrodriguez.me/plugins/search/fuse.min.js"></script>

<script src="https://cmrodriguez.me/plugins/search/mark.js"></script>

<script src="https://cmrodriguez.me/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://cmrodriguez.me/js/script.min.js"></script>
<!-- google analitycs -->
<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'Your ID', 'auto');
  ga('send', 'pageview');
</script></body>
</html>