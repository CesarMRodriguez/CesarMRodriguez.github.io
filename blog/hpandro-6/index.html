<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">

  
  <script data-ad-client="ca-pub-9039902373505756" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z6J58MYYPV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-Z6J58MYYPV');
  </script>
  <title>Cesar Rodriguez | Personal blog</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="frida ctf challenge emulator detection">
  <meta name="author" content="Cesar Rodriguez">
  <meta name="generator" content="Hugo 0.70.0" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/venobox/venobox.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://cmrodriguez.me/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://cmrodriguez.me/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://cmrodriguez.me/images/favicon.png " type="image/x-icon">

</head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view" href="https://cmrodriguez.me"><img class="img-fluid" style="max-height: 5rem;"
          src="https://cmrodriguez.me/images/logo-hermosa2.png" alt="Cesar Rodriguez | Personal blog"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <div class="desktop-view">
          <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="https://twitter.com/warlockk87"><i class="ti-twitter-alt"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/CesarMRodriguez"><i class="ti-github"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.linkedin.com/in/cesar-mario-rodriguez/"><i class="ti-linkedin"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.instagram.com/cesarm_rodriguez/"><i class="ti-instagram"></i></a>
            </li>
            
          </ul>
        </div>

        <a class="navbar-brand mx-auto desktop-view" href="https://cmrodriguez.me"><img class="img-fluid" style="max-height: 5rem;"
            src="https://cmrodriguez.me/images/logo-hermosa2.png" alt="Cesar Rodriguez | Personal blog"></a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://cmrodriguez.me/about">About</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://cmrodriguez.me/blog">Post</a>
          </li>
          
          
          
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              Guides
            </a>
            <div class="dropdown-menu">
              
              <a class="dropdown-item" href="https://cmrodriguez.me/blog/frida-scripting-guide">Frida Scripting Guide</a>
              
              <a class="dropdown-item" href="https://cmrodriguez.me/blog/hpandro">Solving hpAndro</a>
              
            </div>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://cmrodriguez.me/contact">Contact</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://cmrodriguez.me/search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/categories/frida"
          class="text-primary">Frida</a>
        
        <a href="/categories/android"
          class="text-primary">Android</a>
        
        <a href="/categories/ctf"
          class="text-primary">C t f</a>
        
        <a href="/categories/challenge"
          class="text-primary">Challenge</a>
        
        <a href="/categories/emulation-detection"
          class="text-primary">Emulation detection</a>
        
        <h2>Solving CTF with Frida - Part 6</h2>
        <div class="mb-3 post-meta">
          <span>By Cesar Rodriguez</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>26 August 2021</span>
          
        </div>
        
        <img src="https://cmrodriguez.me/images/featured-post/ctf-challenge.png" class="img-fluid w-100 mb-4" alt="Solving CTF with Frida - Part 6">
        
        <div class="content mb-5">
          <p>In this series of posts I&rsquo;ll be solving some persistence challenges from <a href="http://ctf.hpandro.raviramesh.info/">hpandro ctf challenges</a>. hpAndro created an Android application with multiple vulnerabilities, following the <a href="https://github.com/OWASP/owasp-mstg">MSTG</a>.</p>
<p>In this series I&rsquo;ll be reviewing the Emulator Detection techniques implemented in the CTF. I&rsquo;ll explain how each validation is executed and how to bypass them with Frida. I&rsquo;ll show generic validations that could be used in any application regardless the type or level of obfuscation it has.</p>
<p>Emulation Detection techniques basically tries to find whether the application is running on an emulator by checking some properties the OS has, and comparing them with known emulation values (like generic phone numbers used by emulators or values on some system properties). In order to bypass the validations the scripts created need to intercept the functions that return the values from the phone and change them for ones that are not generic.</p>
<p>Note: In order to solve the challenges in a faster are easier way, you can follow the guide from <a href="https://cmrodriguez.me/blog/hpandro-5/">Solving CTF with Frida - Part 5</a>.</p>
<p>We have nine different challenges related to emulation detection mechanisms:</p>
<ul>
<li>Virtual Phone Number validation.</li>
<li>Device ID validation.</li>
<li>Hardware Specifications.</li>
<li>QEMU check.</li>
<li>Emulator Files Check.</li>
<li>Emulator Default IP Check.</li>
<li>Package name Check.</li>
<li>Debug Flag.</li>
<li>Network Operator Name.</li>
</ul>
<h3 id="virtual-phone-number-validation">Virtual Phone Number validation</h3>
<p>This validation is executed in the <strong>com.hpandro.androidsecurity.ui.activity.task.emulatorDetection.VirtualPhoneNumberActivity$init$2.onClick</strong> method:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//validates Shared Preference value
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">string</span> <span class="o">=</span> <span class="n">MainApp</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getSharedPrefEmulatorDetection</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;VirtualPhoneNumberStr&#34;</span><span class="o">,</span> <span class="s">&#34;00&#34;</span><span class="o">);</span>
    <span class="c1">//check is being executed here
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="n">checkPhoneNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">checkPhoneNumber</span><span class="o">();</span>
    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">string</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="s">&#34;F&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="n">checkPhoneNumber</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//shows error and returns
</span><span class="c1"></span>        <span class="o">...</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">...</span>
    <span class="c1">//retrieves virtual phone number flag
</span><span class="c1"></span>    <span class="n">VirtualPhoneNumberActivity</span><span class="o">.</span><span class="na">access$getPresenter$p</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">getEmulatorDetectFlag</span><span class="o">(</span><span class="s">&#34;vpn&#34;</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>This method calls the EmulatorDetector.checkPhoneNumber, which gets the TelephonyManager, and gets the line number one, and then it checks if it is in a list of phone numbers recognized as emulators&rsquo; ones. The phone numbers are hardcoded in the variable PHONE_NUMBERS:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkPhoneNumber</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">systemService</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mContext</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="s">&#34;phone&#34;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">systemService</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">line1Number</span> <span class="o">=</span> <span class="o">((</span><span class="n">TelephonyManager</span><span class="o">)</span> <span class="n">systemService</span><span class="o">).</span><span class="na">getLine1Number</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str</span> <span class="o">:</span> <span class="n">PHONE_NUMBERS</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">line1Number</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">(</span><span class="s">&#34; check phone number is detected&#34;</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">(</span><span class="s">&#34;No permission to detect access of Line1Number&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;null cannot be cast to non-null type android.telephony.TelephonyManager&#34;</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>In this case in order to bypass this control I need to change the way the TelephonyManager returns the phone number. This can be done with the following script:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nb">String</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.lang.String&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">TelephonyManager</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;android.telephony.TelephonyManager&#34;</span><span class="p">);</span>
    <span class="nx">TelephonyManager</span><span class="p">.</span><span class="nx">getLine1Number</span><span class="p">.</span><span class="nx">overload</span><span class="p">().</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getLine1Number</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;entra a telephony manager &#34;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">);</span>
        <span class="c1">//set a valid phone number
</span><span class="c1"></span>        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;152945677&#34;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span> 
</code></pre></div><h3 id="device-id">Device ID</h3>
<p>In this case I could not get to the activity. So I went through the source code to see if it was implemented, and found that there were all the classes needed to execute it. I then called the activity directly from Frida:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span>  <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    
    <span class="kd">var</span> <span class="nx">Intent</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;android.content.Intent&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nb">String</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.lang.String&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">Integer</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.lang.Integer&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">startIntent</span> <span class="o">=</span> <span class="nx">Intent</span><span class="p">.</span><span class="nx">$new</span><span class="p">();</span>
    <span class="nx">startIntent</span><span class="p">.</span><span class="nx">setClassName</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;com.hpandro.androidsecurity&#34;</span><span class="p">),</span><span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;com.hpandro.androidsecurity.ui.activity.task.emulatorDetection.DeviceIDsActivity&#34;</span><span class="p">));</span>
    <span class="nx">startIntent</span><span class="p">.</span><span class="nx">setFlags</span><span class="p">(</span><span class="mh">0x10000000</span><span class="p">);</span>
    <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;android.app.ActivityThread&#39;</span><span class="p">).</span><span class="nx">currentApplication</span><span class="p">().</span><span class="nx">startActivity</span><span class="p">(</span><span class="nx">startIntent</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><p>Whenever I did that the activity was opened, but whenever I pressed the button, nothing happened. I saw the content of the class and checked the onclickin the DeviceIDsActivity$init$2 class. In the onClick method from the DeviceIDsActivity$init$2 class I have the following code:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">string</span> <span class="o">=</span> <span class="n">MainApp</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getSharedPrefEmulatorDetection</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;DeviceIDsStr&#34;</span><span class="o">,</span> <span class="s">&#34;00&#34;</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">checkImsi</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">checkImsi</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">checkDeviceId</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">checkDeviceId</span><span class="o">();</span>
    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">string</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="s">&#34;F&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">checkDeviceId</span> <span class="o">&amp;&amp;</span> <span class="n">checkImsi</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">.</span><span class="na">_$_findCachedViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tvDetails</span><span class="o">);</span>
        <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">textView</span><span class="o">,</span> <span class="s">&#34;tvDetails&#34;</span><span class="o">);</span>
        <span class="n">textView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">checkImsi</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">TextView</span> <span class="n">textView2</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">.</span><span class="na">_$_findCachedViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tvDetails</span><span class="o">);</span>
            <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">textView2</span><span class="o">,</span> <span class="s">&#34;tvDetails&#34;</span><span class="o">);</span>
            <span class="n">textView2</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">device_id</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; detected as\n\n&#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">getDetectedImsi</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">checkDeviceId</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">TextView</span> <span class="n">textView3</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">.</span><span class="na">_$_findCachedViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tvDetails</span><span class="o">);</span>
            <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">textView3</span><span class="o">,</span> <span class="s">&#34;tvDetails&#34;</span><span class="o">);</span>
            <span class="n">textView3</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">device_id</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; detected as\n\n&#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">getDeviceId</span><span class="o">());</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><p>I checked the values that the &ldquo;DeviceIDsStr&rdquo;, checkImsi and checkDeviceId returned to see what happens:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nb">String</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.lang.String&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">MainApp</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;com.hpandro.androidsecurity.MainApp&#34;</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">MainApp</span><span class="p">.</span><span class="nx">Companion</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">getSharedPrefEmulatorDetection</span><span class="p">().</span><span class="nx">getString</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;DeviceIDsStr&#34;</span><span class="p">),</span> <span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;00&#34;</span><span class="p">))</span> <span class="p">);</span>     

    <span class="c1">//I need to get the context to call EmulatorDetector
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;android.app.ActivityThread&#39;</span><span class="p">).</span><span class="nx">currentApplication</span><span class="p">().</span><span class="nx">getApplicationContext</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">EmulatorDetector</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;com.hpandro.androidsecurity.utils.emulatorDetection.EmulatorDetector&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">emulatorDetector</span> <span class="o">=</span> <span class="nx">EmulatorDetector</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emulatorDetector</span><span class="p">.</span><span class="nx">checkImsi</span><span class="p">());</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">emulatorDetector</span><span class="p">.</span><span class="nx">checkDeviceId</span><span class="p">());</span>
<span class="p">});</span>
</code></pre></div><p>That script returned:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="m">00000000000000</span>
<span class="nb">false</span>
<span class="nb">false</span>
</code></pre></div><p>So based on the responses, what happens in the onClick method is that the app gets in the &ldquo;if&rdquo;, because the &ldquo;DeviceIDsStr&rdquo; does not have any &ldquo;F&rdquo; on the content, and it does not print any message because the two conditions of root detection are not fulfilled. So in this case to show the result we can change the method that validates the &ldquo;F&rdquo; in the Shared Preference file:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    
    <span class="kd">var</span> <span class="nx">StringKt</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;kotlin.text.StringsKt__StringsKt&#34;</span><span class="p">);</span>
    <span class="nx">StringKt</span><span class="p">.</span><span class="nx">contains$default</span><span class="p">.</span><span class="nx">overload</span><span class="p">(</span><span class="s1">&#39;java.lang.CharSequence&#39;</span><span class="p">,</span> <span class="s1">&#39;java.lang.CharSequence&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;java.lang.Object&#39;</span><span class="p">).</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">charSeq</span><span class="p">,</span> <span class="nx">charSeq2</span><span class="p">,</span><span class="nx">boolZ</span><span class="p">,</span> <span class="nx">intI</span><span class="p">,</span> <span class="nx">objO</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">charSeq2</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;F&#34;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;entra&#34;</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">contains$default</span><span class="p">(</span><span class="nx">charSeq</span><span class="p">,</span> <span class="nx">charSeq2</span><span class="p">,</span><span class="nx">boolZ</span><span class="p">,</span> <span class="nx">intI</span><span class="p">,</span> <span class="nx">objO</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div><p>And after that I received the flag: <strong>hpandro{emudid.FNvq8tpbMtDweNn7gsgazfz5FuO5rxrg}</strong></p>
<p>If you have an scenario where any of the two validations shown (imsi_ids and device_id) returns true, the following script can be used:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nb">String</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.lang.String&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">TelephonyManager</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;android.telephony.TelephonyManager&#34;</span><span class="p">);</span>
    <span class="nx">TelephonyManager</span><span class="p">.</span><span class="nx">getDeviceId</span><span class="p">.</span><span class="nx">overload</span><span class="p">().</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">//set a valid device id
</span><span class="c1"></span>        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;000000000000001&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">TelephonyManager</span><span class="p">.</span><span class="nx">getSubscriberId</span><span class="p">.</span><span class="nx">overload</span><span class="p">().</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">//set a valid suscriber id
</span><span class="c1"></span>        <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;310260000000001&#34;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div><p>You can change the values returned in each overloaded function to return a valid value taken from a cellphone.</p>
<h3 id="hardware-specifications">Hardware Specifications</h3>
<p>In this case the values checked are the ones from the class Build. In order to bypass them we can change the values from generic ones related to the VM to valid ones from a phone, so there is no way to detect it.</p>
<p>The validation with genymotion threw three errors:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">HARDWARE: vbox86
PRODUCT: vbox86p
BOARD:<span class="o">(</span>has<span class="o">)</span> unknown
</code></pre></div><p>We need to patch them. We could patch all the values as well, but in this case we&rsquo;ll do it just with the ones that are detected by the application:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nb">String</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.lang.String&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">Build</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;android.os.Build&#34;</span><span class="p">);</span>
    <span class="nx">Build</span><span class="p">.</span><span class="nx">HARDWARE</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;anything&#34;</span><span class="p">);</span>
    <span class="nx">Build</span><span class="p">.</span><span class="nx">PRODUCT</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;anything&#34;</span><span class="p">);</span>
    <span class="nx">Build</span><span class="p">.</span><span class="nx">BOARD</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;anything&#34;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><p>Note that for doing this, the best moment is at the start of the execution of the application with early instrumentation.</p>
<h3 id="qemu-detection">QEMU detection</h3>
<p>This is similar to the case of DEVICEID. I could not get to the Activity, so I had to navigate with Frida to the component and then force the change of the validation of StringKt to true.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span>  <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    
    <span class="kd">var</span> <span class="nx">Intent</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;android.content.Intent&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nb">String</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.lang.String&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">Integer</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.lang.Integer&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">startIntent</span> <span class="o">=</span> <span class="nx">Intent</span><span class="p">.</span><span class="nx">$new</span><span class="p">();</span>
    <span class="nx">startIntent</span><span class="p">.</span><span class="nx">setClassName</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;com.hpandro.androidsecurity&#34;</span><span class="p">),</span><span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;com.hpandro.androidsecurity.ui.activity.task.emulatorDetection.QEMUDetectionActivity&#34;</span><span class="p">));</span>
    <span class="nx">startIntent</span><span class="p">.</span><span class="nx">setFlags</span><span class="p">(</span><span class="mh">0x10000000</span><span class="p">);</span>
    <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;android.app.ActivityThread&#39;</span><span class="p">).</span><span class="nx">currentApplication</span><span class="p">().</span><span class="nx">startActivity</span><span class="p">(</span><span class="nx">startIntent</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><p>This detection has multiple validations:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">string</span> <span class="o">=</span> <span class="n">MainApp</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getSharedPrefEmulatorDetection</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;QEMUStr&#34;</span><span class="o">,</span> <span class="s">&#34;00&#34;</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">checkQEmuDrivers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">checkQEmuDrivers</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">checkQEmuProps</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">checkQEmuProps</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">checkFiles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">checkFiles</span><span class="o">(</span><span class="n">EmulatorDetector</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getX86_FILES</span><span class="o">(),</span> <span class="s">&#34;X86&#34;</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">checkFiles2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">checkFiles</span><span class="o">(</span><span class="n">EmulatorDetector</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getPIPES</span><span class="o">(),</span> <span class="s">&#34;Pipes&#34;</span><span class="o">);</span>
    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">((!</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">string</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="s">&#34;F&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">checkQEmuDrivers</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">checkQEmuProps</span> <span class="o">||</span> <span class="n">checkFiles</span><span class="o">)))</span> <span class="o">&amp;&amp;</span> <span class="n">checkFiles2</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//show message error
</span><span class="c1"></span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">//retrieve the flag
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>a) Check QEMU Drivers</strong></p>
<p>This control executes the validation by opening the <strong>/proc/tty/drivers</strong> and <strong>/proc/cpuinfo</strong> files and checking in the content if they have the word <em>goldfish</em> on them (stored in the variable QEMU_DRIVERS):</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkQEmuDrivers</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">File</span><span class="o">[]</span> <span class="n">fileArr</span> <span class="o">=</span> <span class="o">{</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;/proc/tty/drivers&#34;</span><span class="o">),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;/proc/cpuinfo&#34;</span><span class="o">)};</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">2</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">fileArr</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">file</span><span class="o">.</span><span class="na">canRead</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bArr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="o">];</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">FileInputStream</span> <span class="n">fileInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
                <span class="n">fileInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bArr</span><span class="o">);</span>
                <span class="n">fileInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">bArr</span><span class="o">,</span> <span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str2</span> <span class="o">:</span> <span class="n">QEMU_DRIVERS</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str2</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">(</span><span class="s">&#34;Check QEmuDrivers is detected&#34;</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>In this case I decided to modify the <em>FileInputStream</em> in order to avoid returning a file wih <em>goldfish</em> as content. Another strategy could be to change the File constructor and checking if the file being opened by the application is <strong>/proc/tty/drivers</strong> or <strong>/proc/cpuinfo</strong>. In those cases you could retrieve the content of the files returned by a real cellphone (to do this you could upload the file examples to /tmp).</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">FileIS</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.io.FileInputStream&#34;</span><span class="p">);</span>
    <span class="nx">FileIS</span><span class="p">.</span><span class="nx">read</span><span class="p">.</span><span class="nx">overload</span><span class="p">(</span><span class="s1">&#39;[B&#39;</span><span class="p">).</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">byteArray</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;entra&#34;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">retByteArray</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">byteArray</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span> <span class="nx">byteArray</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;goldfish&#34;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;goldfish&#34;</span><span class="p">);</span>
            <span class="nx">byteArray</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;a&#34;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="nx">byteArray</span><span class="p">[</span><span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;a&#34;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="nx">byteArray</span><span class="p">[</span><span class="nx">index</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;a&#34;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="nx">byteArray</span><span class="p">[</span><span class="nx">index</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;a&#34;</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">retByteArray</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div><p>To confirm the change you could intercept the following function:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    
    <span class="kd">var</span> <span class="nx">StringKt</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;kotlin.text.StringsKt__StringsKt&#34;</span><span class="p">);</span>
    <span class="nx">StringKt</span><span class="p">.</span><span class="nx">contains$default</span><span class="p">.</span><span class="nx">overload</span><span class="p">(</span><span class="s1">&#39;java.lang.CharSequence&#39;</span><span class="p">,</span> <span class="s1">&#39;java.lang.CharSequence&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;java.lang.Object&#39;</span><span class="p">).</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">charSeq</span><span class="p">,</span> <span class="nx">charSeq2</span><span class="p">,</span><span class="nx">boolZ</span><span class="p">,</span> <span class="nx">intI</span><span class="p">,</span> <span class="nx">objO</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;charSeq1: &#34;</span> <span class="o">+</span> <span class="nx">charSeq</span> <span class="o">+</span> <span class="s2">&#34; charSeq2: &#34;</span> <span class="o">+</span> <span class="nx">charSeq2</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">contains$default</span><span class="p">(</span><span class="nx">charSeq</span><span class="p">,</span> <span class="nx">charSeq2</span><span class="p">,</span><span class="nx">boolZ</span><span class="p">,</span> <span class="nx">intI</span><span class="p">,</span> <span class="nx">objO</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div><p><strong>b) checkQEmuProps</strong></p>
<p>In this case the validation is the following one:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkQEmuProps</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Property</span><span class="o">[]</span> <span class="n">propertyArr</span> <span class="o">=</span> <span class="n">PROPERTIES</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Property</span> <span class="n">property</span> <span class="o">:</span> <span class="n">propertyArr</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">getProp</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mContext</span><span class="o">,</span> <span class="n">property</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">property</span><span class="o">.</span><span class="na">getSeek_value</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">prop</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">i</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">property</span><span class="o">.</span><span class="na">getSeek_value</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">prop</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">seek_value</span> <span class="o">=</span> <span class="n">property</span><span class="o">.</span><span class="na">getSeek_value</span><span class="o">();</span>
            <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">seek_value</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">prop</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">seek_value</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">i</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">5</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">log</span><span class="o">(</span><span class="s">&#34;Check QEmuProps is detected&#34;</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>which calls the following validation:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">getProp</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadClass</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="s">&#34;android.os.SystemProperties&#34;</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">invoke</span> <span class="o">=</span> <span class="n">loadClass</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;get&#34;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="n">loadClass</span><span class="o">,</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">str</span><span class="o">},</span> <span class="n">1</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">invoke</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">invoke</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;null cannot be cast to non-null type kotlin.String&#34;</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>In this case I reviewed the values retrieved by the SystemProperties in Genymotion and the only one I had to change was <strong>ro.hardware</strong>. Whenever you face this validation you might need to change another values as well:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">SystemProperties</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;android.os.SystemProperties&#34;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nb">String</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.lang.String&#34;</span><span class="p">);</span>
    <span class="nx">SystemProperties</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">overload</span><span class="p">(</span><span class="s1">&#39;java.lang.String&#39;</span><span class="p">).</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span> <span class="o">+</span> <span class="s2">&#34;= &#34;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">str</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">str</span> <span class="o">==</span> <span class="s2">&#34;ro.hardware&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">$new</span><span class="p">(</span><span class="s2">&#34;vbox86&#34;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>    
<span class="p">});</span>
</code></pre></div><p><strong>c) checkFiles</strong></p>
<p>In this validation, the application checks if some files exist on the cellphone which only exist on some emulators. This validation is done with two different list of files:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">boolean</span> <span class="n">checkFiles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">checkFiles</span><span class="o">(</span><span class="n">EmulatorDetector</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getX86_FILES</span><span class="o">(),</span> <span class="s">&#34;X86&#34;</span><span class="o">);</span>
<span class="kt">boolean</span> <span class="n">checkFiles2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmulatorDetector</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">this$0</span><span class="o">).</span><span class="na">checkFiles</span><span class="o">(</span><span class="n">EmulatorDetector</span><span class="o">.</span><span class="na">Companion</span><span class="o">.</span><span class="na">getPIPES</span><span class="o">(),</span> <span class="s">&#34;Pipes&#34;</span><span class="o">);</span>
</code></pre></div><p>The validation executed is the following one:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkFiles</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">strArr</span><span class="o">,</span> <span class="n">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullParameter</span><span class="o">(</span><span class="n">strArr</span><span class="o">,</span> <span class="s">&#34;targets&#34;</span><span class="o">);</span>
    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullParameter</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="s">&#34;type&#34;</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str2</span> <span class="o">:</span> <span class="n">strArr</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">str2</span><span class="o">).</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">(</span><span class="s">&#34;Check &#34;</span> <span class="o">+</span> <span class="n">str</span> <span class="o">+</span> <span class="s">&#34; is detected&#34;</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>So the script generated modifies the behavior of the <strong>exists</strong> method on the class File:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">File</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.io.File&#34;</span><span class="p">);</span>
    <span class="nx">File</span><span class="p">.</span><span class="nx">exists</span><span class="p">.</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">path_file</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> 
        <span class="k">if</span> <span class="p">(</span><span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;ueventd.android_x86.rc&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;x86.prop&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;ueventd.ttVM_x86.rc&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;init.ttVM_x86.rc&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;fstab.ttVM_x86&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;fstab.vbox86&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;init.vbox86.rc&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;ueventd.vbox86.rc&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/dev/socket/qemud&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/dev/goldfish_pipe&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/dev/qemu_pipe&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;DID NOT WORK: &#34;</span> <span class="o">+</span> <span class="nx">path_file</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">exists</span><span class="p">();</span>
    <span class="p">}</span>    
<span class="p">});</span>
</code></pre></div><h3 id="emulator-files-check-task">Emulator Files Check Task</h3>
<p>This validation is the same as the one used in the previous validation, but the files to control are other ones. I updated the same script, but extended it for the new files:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span> <span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">File</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.io.File&#34;</span><span class="p">);</span>
    <span class="nx">File</span><span class="p">.</span><span class="nx">exists</span><span class="p">.</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">path_file</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> 
        <span class="k">if</span> <span class="p">(</span><span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;ueventd.android_x86.rc&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;x86.prop&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;ueventd.ttVM_x86.rc&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;init.ttVM_x86.rc&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;fstab.ttVM_x86&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;fstab.vbox86&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;init.vbox86.rc&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;ueventd.vbox86.rc&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/dev/socket/qemud&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/dev/goldfish_pipe&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/dev/qemu_pipe&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/dev/socket/genyd&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/dev/socket/baseband_genyd&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/system/genymotion/wallpapers/genymotion.png&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/system/bin/genybaseband&#34;</span> <span class="o">||</span> <span class="nx">path_file</span> <span class="o">==</span> <span class="s2">&#34;/system/vendor/bin/hw/android.hardware.health@2.0-service.genymotion&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">exists</span><span class="p">();</span>
    <span class="p">}</span>    
<span class="p">});</span>
</code></pre></div><h3 id="emulator-default-ip-check">Emulator Default Ip Check</h3>
<p>In this case the application works on the netcfg command and searches for the ip address assigned to the app. We&rsquo;ll change the way the content is returned in order to avoid the detection of the validation. The code of the validation is the following one:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkIp</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ContextCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mContext</span><span class="o">,</span> <span class="s">&#34;android.permission.INTERNET&#34;</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">strArr</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;/system/bin/netcfg&#34;</span><span class="o">};</span>
        <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ProcessBuilder</span> <span class="n">processBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">((</span><span class="n">String</span><span class="o">[])</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">strArr</span><span class="o">,</span> <span class="n">1</span><span class="o">));</span>
            <span class="n">processBuilder</span><span class="o">.</span><span class="na">directory</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;/system/bin/&#34;</span><span class="o">));</span>
            <span class="n">processBuilder</span><span class="o">.</span><span class="na">redirectErrorStream</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">Process</span> <span class="n">start</span> <span class="o">=</span> <span class="n">processBuilder</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="s">&#34;process&#34;</span><span class="o">);</span>
            <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bArr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="o">];</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bArr</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">bArr</span><span class="o">,</span> <span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">sb2</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">sb2</span><span class="o">,</span> <span class="s">&#34;stringBuilder.toString()&#34;</span><span class="o">);</span>
        <span class="n">log</span><span class="o">(</span><span class="s">&#34;netcfg data -&gt; &#34;</span> <span class="o">+</span> <span class="n">sb2</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">sb2</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">str</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Object</span><span class="o">[]</span> <span class="n">array</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Regex</span><span class="o">(</span><span class="s">&#34;\n&#34;</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">0</span><span class="o">).</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">array</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span><span class="o">[]</span> <span class="n">strArr2</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">[])</span> <span class="n">array</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str2</span> <span class="o">:</span> <span class="n">strArr2</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">str3</span> <span class="o">=</span> <span class="n">str2</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str3</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="s">&#34;wlan0&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str3</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="s">&#34;tunl0&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str3</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="s">&#34;eth0&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str3</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">IP</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="n">StringsKt</span><span class="o">.</span><span class="na">contains$default</span><span class="o">((</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">str3</span><span class="o">,</span> <span class="o">(</span><span class="n">CharSequence</span><span class="o">)</span> <span class="n">IP1</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">)))</span> <span class="o">{</span>
                        <span class="n">log</span><span class="o">(</span><span class="s">&#34;Check IP is detected &#34;</span> <span class="o">+</span> <span class="n">str2</span><span class="o">);</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;null cannot be cast to non-null type kotlin.Array&lt;T&gt;&#34;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>The script created to bypass it is the following. I took an example of netcfg output, and changed it in order to avoid the validation. Then I uploaded the file to /tmp/test.txt:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ProcessBuilder</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;java.lang.ProcessBuilder&#34;</span><span class="p">);</span>
    <span class="nx">ProcessBuilder</span><span class="p">.</span><span class="nx">$init</span><span class="p">.</span><span class="nx">overload</span><span class="p">(</span><span class="s1">&#39;[Ljava.lang.String;&#39;</span><span class="p">).</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;/system/bin/netcfg&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
            <span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;cat&#34;</span><span class="p">;</span>
            <span class="nx">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;/tmp/test.txt&#34;</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">$init</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">$init</span><span class="p">(</span><span class="nx">array</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div><h3 id="check-package-name">Check Package Name</h3>
<p>In this case the validation executed is the following one:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkPackageNameDetect</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">strArr</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullParameter</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="s">&#34;mContext&#34;</span><span class="o">);</span>
    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullParameter</span><span class="o">(</span><span class="n">strArr</span><span class="o">,</span> <span class="s">&#34;additionalRootManagementApps&#34;</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">z</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">ArrayList</span> <span class="n">arrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">(</span><span class="n">CollectionsKt</span><span class="o">.</span><span class="na">listOf</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">&#34;com.google.android.launcher.layouts.genymotion&#34;</span><span class="o">,</span> <span class="s">&#34;com.bluestacks&#34;</span><span class="o">,</span> <span class="s">&#34;com.bignox.app&#34;</span><span class="o">,</span> <span class="s">&#34;com.genymotion.genyd&#34;</span><span class="o">,</span> <span class="s">&#34;com.genymotion.systempatcher&#34;</span><span class="o">,</span> <span class="s">&#34;com.genymotion.tasklocker&#34;</span><span class="o">}.</span><span class="na">toString</span><span class="o">()));</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">strArr</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">z</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">z</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">arrayList</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">((</span><span class="n">String</span><span class="o">[])</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">strArr</span><span class="o">,</span> <span class="n">strArr</span><span class="o">.</span><span class="na">length</span><span class="o">)));</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">isAnyPackageFromListInstalled</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">arrayList</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>which calls the following method:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isAnyPackageFromListInstalled</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">PackageManager</span> <span class="n">packageManager</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">();</span>
    <span class="n">Intrinsics</span><span class="o">.</span><span class="na">checkNotNullExpressionValue</span><span class="o">(</span><span class="n">packageManager</span><span class="o">,</span> <span class="s">&#34;mContext!!.packageManager&#34;</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">z</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">packageManager</span><span class="o">.</span><span class="na">getPackageInfo</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">Object</span><span class="o">)</span> <span class="o">(</span><span class="s">&#34;&gt;&gt;&gt;&gt;&gt;&gt; &#34;</span> <span class="o">+</span> <span class="n">str</span> <span class="o">+</span> <span class="s">&#34; ROOT management app detected!&#34;</span><span class="o">));</span>
            <span class="n">z</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PackageManager</span><span class="o">.</span><span class="na">NameNotFoundException</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">z</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>If the application were not optimized the following script should work:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

   <span class="kd">var</span> <span class="nx">PackageManagerNotFound</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;android.content.pm.PackageManager$NameNotFoundException&#34;</span><span class="p">);</span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">PackageManagerNotFound</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">PackageManager</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;android.content.pm.PackageManager&#34;</span><span class="p">);</span>
   <span class="nx">PackageManager</span><span class="p">.</span><span class="nx">getPackageInfo</span><span class="p">.</span><span class="nx">overload</span><span class="p">(</span><span class="s1">&#39;java.lang.String&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">).</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">valInt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">str</span> <span class="o">==</span> <span class="s2">&#34;com.google.android.launcher.layouts.genymotion&#34;</span> <span class="o">||</span> <span class="nx">str</span> <span class="o">==</span> <span class="s2">&#34;com.bluestacks&#34;</span> <span class="o">||</span> <span class="nx">str</span> <span class="o">==</span> <span class="s2">&#34;com.bignox.app&#34;</span> <span class="o">||</span> <span class="nx">str</span> <span class="o">==</span> <span class="s2">&#34;com.genymotion.genyd&#34;</span> <span class="o">||</span> <span class="nx">str</span> <span class="o">==</span> <span class="s2">&#34;com.genymotion.systempatcher&#34;</span> <span class="o">||</span> <span class="nx">str</span> <span class="o">==</span> <span class="s2">&#34;com.genymotion.tasklocker&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">PackageManagerNotFound</span><span class="p">.</span><span class="nx">$new</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getPackageInfo</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">valInt</span><span class="p">);</span>
        <span class="p">}</span>
   <span class="p">}</span> 
<span class="p">});</span>
</code></pre></div><p>But as in my case the application was installed in an OS with optimizations, the resolution of the PackageManager isn&rsquo;t in the Java layer. I still do not know how to intercept this, so I leave the standard resolution used in the root detection blogpost:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">EmulatorDetector</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;com.hpandro.androidsecurity.utils.emulatorDetection.EmulatorDetector&#34;</span><span class="p">);</span>
    <span class="nx">EmulatorDetector</span><span class="p">.</span><span class="nx">checkPackageNameDetect</span><span class="p">.</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">strArr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div><h3 id="debug-flag">Debug Flag</h3>
<p>This is an atypical validation, because it checks a flag that is in the <strong>EmulatorDetector</strong> class, called <strong>isDebug</strong>. This value does not seem to be set anywhere in the application, so I just created an script like the one in the previous example:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">EmulatorDetector</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;com.hpandro.androidsecurity.utils.emulatorDetection.EmulatorDetector&#34;</span><span class="p">);</span>
    <span class="nx">EmulatorDetector</span><span class="p">.</span><span class="nx">isDebug</span><span class="p">.</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div><h3 id="network-operator-name">Network Operator Name</h3>
<p>In this case the validation is the following one:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">checkOperatorNameAndroid</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">systemService</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mContext</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="s">&#34;phone&#34;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">systemService</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;null cannot be cast to non-null type android.telephony.TelephonyManager&#34;</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">StringsKt</span><span class="o">.</span><span class="na">equals</span><span class="o">(((</span><span class="n">TelephonyManager</span><span class="o">)</span> <span class="n">systemService</span><span class="o">).</span><span class="na">getNetworkOperatorName</span><span class="o">(),</span> <span class="s">&#34;android&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">(</span><span class="s">&#34;Check operator name android is detected&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>This method uses the TelephonyManager as well, but it validates whether the NetworkOperatorName is <strong>android</strong>. As I already created scripts patching the TelephonyManager, I&rsquo;ll not explain the solution:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Java</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span> <span class="n">function</span> <span class="o">()</span> <span class="o">{</span>
    <span class="n">var</span> <span class="n">String</span> <span class="o">=</span> <span class="n">Java</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="s">&#34;java.lang.String&#34;</span><span class="o">);</span>
    <span class="n">var</span> <span class="n">TelephonyManager</span> <span class="o">=</span> <span class="n">Java</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="s">&#34;android.telephony.TelephonyManager&#34;</span><span class="o">);</span>
    <span class="n">TelephonyManager</span><span class="o">.</span><span class="na">getNetworkOperatorName</span><span class="o">.</span><span class="na">overload</span><span class="o">().</span><span class="na">implementation</span> <span class="o">=</span> <span class="n">function</span> <span class="o">()</span> <span class="o">{</span>
        <span class="c1">//set a valid device id
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">$new</span><span class="o">(</span><span class="s">&#34;android&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div><h3 id="conclusion">Conclusion</h3>
<p>The controls shown in this application are commonly seen in production applications. As pentesters, it is important to understand them in order to find patterns in the applications we are analyzing to try to detect these controls and patch them in order to continue with the security analysis of the target. As a developer it is good to know how the controls work and how an attacker could try to bypass them.</p>
<p>In the blog I created several generic scripts that could work on any phone, so in case you find any validation related to emulation, you can use these in order to bypass them.</p>

        </div>

        
        
      </div>
    </div>
  </div>
</section>



<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><i
                class="ti-twitter mr-3 text-primary"></i>@warlockk87</li>
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>Buenos Aires, Argentina</li>
          <li class="mb-3"><a class="text-dark" href="mailto:cmrodriguez.mobile@gmail.com"><i
                class="ti-email mr-3 text-primary"></i>cmrodriguez.mobile@gmail.com</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://twitter.com/warlockk87">twitter</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://github.com/CesarMRodriguez">github</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.linkedin.com/in/cesar-mario-rodriguez/">linkedin</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.instagram.com/cesarm_rodriguez/">instagram</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/categories/android">Android</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/automation">Automation</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/bug">Bug</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/challenge">Challenge</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ctf">Ctf</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/emulation-detection">Emulation detection</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/frida">Frida</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/http">Http</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/https">Https</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/misc">Misc</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/pixeldungeon">Pixeldungeon</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/root-detection">Root detection</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/sqlite">Sqlite</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/tcp">Tcp</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/udp">Udp</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/websocket">Websocket</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/about">About</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/blog">Post</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/guides">Guides</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/contact">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | copyright  2020 <a href="https://cmrodriguez.me">Cesar Rodriguez</a> All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://cmrodriguez.me/index.json"
</script>

<!-- JS Plugins -->

<script src="https://cmrodriguez.me/plugins/jQuery/jquery.min.js"></script>

<script src="https://cmrodriguez.me/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://cmrodriguez.me/plugins/slick/slick.min.js"></script>

<script src="https://cmrodriguez.me/plugins/venobox/venobox.min.js"></script>

<script src="https://cmrodriguez.me/plugins/search/fuse.min.js"></script>

<script src="https://cmrodriguez.me/plugins/search/mark.js"></script>

<script src="https://cmrodriguez.me/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://cmrodriguez.me/js/script.min.js"></script>
<!-- google analitycs -->
<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'Your ID', 'auto');
  ga('send', 'pageview');
</script></body>
</html>